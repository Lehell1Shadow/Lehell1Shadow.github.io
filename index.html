<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyline - Sistema de Solicitudes</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-light: #f8f9fa;
            --secondary-light: #e9ecef;
            --accent-color: #8c2f3e;
            --accent-light: #a83d4e;
            --accent-dark: #5d1f29;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --navbar-bg: #2c3e50;
            --navbar-text: #ffffff;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--secondary-light);
            color: var(--text-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Estilos para el login */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-logo i {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        
        .login-logo h1 {
            color: var(--text-dark);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .login-logo p {
            color: var(--text-muted);
            margin-bottom: 0;
        }
        
        .login-form .form-control {
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .login-form .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(140, 47, 62, 0.25);
        }
        
        .login-btn {
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%);
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(140, 47, 62, 0.4);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--navbar-text);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Ocultar contenido principal hasta el login */
        .main-content {
            display: none;
        }
        
        .navbar {
            display: none;
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 0;
            transition: all 0.3s ease;
            z-index: 1030;
        }
        
        .navbar-brand {
            color: var(--navbar-text) !important;
            font-weight: 700;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
        }
        
        .floating-action-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-dark) 0%, var(--accent-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: none;
            font-size: 1.5rem;
        }
        
        /* Estilos existentes de la aplicaci贸n */
        .main-content {
            padding: 15px;
            padding-top: 80px;
            background-color: var(--secondary-light);
            position: relative;
            z-index: 1;
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: none;
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background-color: var(--card-bg);
            color: var(--text-dark);
            border-radius: 12px 12px 0 0 !important;
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(140, 47, 62, 0.3);
        }
        
        .data-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
        }
        
        .data-empty i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--border-color);
        }
        
        .client-info {
            font-size: 0.9rem;
        }
        
        .client-info p {
            margin-bottom: 0.3rem;
        }
        
        .client-detail-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .client-detail-label {
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            background-color: #fff5f5 !important;
        }

        .is-valid {
            border-color: #28a745 !important;
            background-color: #f8fff9 !important;
        }

        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
        
        .payment-calculation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .calculation-result {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1rem;
        }
        
        .table-responsive {
            overflow-x: auto;
            font-size: 0.85rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        
        .status-pending {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .status-approved {
            background-color: #28a745 !important;
            color: white !important;
        }

        .status-rejected {
            background-color: #dc3545 !important;
            color: white !important;
        }

        .status-review {
            background-color: #17a2b8 !important;
            color: white !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa;
        }
        
        /* MEJORAS ESPECFICAS PARA EL SCANNER DE INE */
        .scanner-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }
        
        .scanner-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 95%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .scanner-frame {
            width: 100%;
            max-width: 350px;
            height: 220px;
            border: 3px solid #8c2f3e;
            border-radius: 10px;
            margin: 15px auto;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scanner-frame::before {
            content: "Coloque la INE dentro del marco";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            width: 80%;
            z-index: 1;
        }
        
        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .scanner-canvas {
            display: none;
        }
        
        .scanner-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
            border: 2px solid #dee2e6;
        }
        
        .scanner-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .scanner-actions .btn {
            min-width: 120px;
            padding: 10px 15px;
        }
        
        .scanner-note {
            margin-top: 15px;
            font-size: 0.85rem;
            color: #6c757d;
            text-align: center;
        }
        
        .scanner-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .scanner-checkbox input {
            margin-right: 8px;
        }
        
        /* Indicador de orientaci贸n */
        .orientation-indicator {
            display: none;
            background: #e7f3ff;
            color: #0066cc;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        .scanner-container.active .orientation-indicator {
            display: block;
        }
        
        /* Estados del scanner */
        .scanner-container.capturing .scanner-frame {
            border-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }
        
        .scanner-container.processing .scanner-frame::before {
            content: "Procesando INE...";
            color: #8c2f3e;
        }
        
        /* Resultados mejorados */
        .scan-results-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background-color: #f8f9fa;
            text-align: left;
        }
        
        .scan-result-item {
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            background: white;
            border-left: 4px solid #28a745;
        }
        
        .scan-result-error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .scan-result-warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .data-highlight {
            background: #e7f3ff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            color: #0066cc;
            display: inline-block;
            margin: 2px 0;
        }
        
        .ine-input-group {
            position: relative;
        }
        
        .scan-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .location-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .location-btn:hover {
            background: var(--accent-light);
            transform: translateY(-50%) scale(1.05);
        }
        
        .location-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: translateY(-50%);
        }
        
        /* Modal mejorado para m贸viles */
        .modal-dialog {
            margin: 10px;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        /* Tabs mejorados para m贸viles */
        .nav-tabs .nav-link {
            font-size: 0.9rem;
            padding: 10px 12px;
        }
        
        /* Badge mejorado */
        .badge {
            font-size: 0.75rem;
        }
        
        /* Mejoras para tablas en m贸viles */
        @media (max-width: 576px) {
            .table th, .table td {
                padding: 8px 5px;
            }
            
            .btn-sm {
                padding: 5px 8px;
                font-size: 0.8rem;
            }
            
            .main-content {
                padding: 10px;
                padding-top: 70px;
            }
            
            .card-header {
                padding: 12px 15px;
            }
            
            .floating-action-btn {
                display: flex;
            }
            
            .desktop-action-btn {
                display: none !important;
            }
        }
        
        /* Estilos para escritorio */
        @media (min-width: 992px) {
            .main-content {
                padding: 20px;
                padding-top: 100px;
            }
            
            .floating-action-btn {
                display: none;
            }
            
            .desktop-action-btn {
                display: inline-flex;
            }
            
            .modal-dialog {
                margin: 1.75rem auto;
                max-width: 800px;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
        }
        
        /* Estado de ubicaci贸n */
        .location-status {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        
        .location-success {
            color: #198754;
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
        }
        
        .location-error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .location-loading {
            color: #ffc107;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        
        /* Header actions para escritorio */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Informaci贸n del promotor en el formulario */
        .promotor-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-color);
        }

        .promotor-info-label {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .promotor-info-value {
            color: var(--text-dark);
        }

        /* Nuevos estilos para la secci贸n de garant铆a */
        .guarantee-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid var(--accent-color);
        }
        
        .guarantee-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .camera-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        /* NUEVO: Estilos para la secci贸n de fachada */
        .facade-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #17a2b8;
        }
        
        .facade-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .facade-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        /* NUEVO: Estilos para botones de subir archivo */
        .upload-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            margin-left: 10px;
        }
        
        .photo-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        /* NUEVO: Estilos para notificaciones */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
        }
        
        /* NUEVO: Estilos para resultados del esc谩ner */
        .extracted-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #198754;
        }

        .extracted-ine {
            font-family: monospace;
            font-size: 1.1em;
            color: #0d6efd;
        }

        /* NUEVOS ESTILOS MEJORADOS PARA RESULTADOS DE ESCANEO */
        .extraction-debug {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        /* Estilos para autocompletado de Google */
        .pac-container {
            z-index: 1051 !important;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #ddd;
        }

        .pac-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .pac-item:hover {
            background-color: #f8f9fa;
        }

        .pac-item-query {
            font-size: 0.9rem;
            color: #495057;
        }

        .pac-matched {
            font-weight: bold;
            color: var(--accent-color);
        }

        /* ===== MEJORAS ESPECFICAS PARA MVILES ===== */
        @media (max-width: 768px) {
            /* Scanner optimizado para m贸viles */
            .scanner-content {
                width: 98%;
                margin: 10px;
                padding: 20px 15px;
            }
            
            .scanner-frame {
                height: 200px;
                max-width: 300px;
            }
            
            .scanner-actions {
                flex-direction: column;
            }
            
            .scanner-actions .btn {
                width: 100%;
                margin: 3px 0;
            }
            
            /* Mejoras en la visualizaci贸n de resultados */
            .scan-results-container {
                max-height: 50vh;
                overflow-y: auto;
                font-size: 0.9rem;
            }
            
            .scan-result-item {
                padding: 10px;
                margin: 8px 0;
            }
            
            /* Modal optimizado para m贸viles */
            .modal-dialog {
                margin: 5px;
                max-width: none;
            }
            
            .modal-content {
                border-radius: 12px;
            }
            
            /* Tabs optimizados para m贸viles */
            .nav-tabs .nav-link {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            /* Botones de acci贸n en m贸viles */
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                margin: 3px 0;
            }
            
            /* Formulario optimizado para m贸viles */
            .form-control, .form-select {
                font-size: 16px; /* Previene zoom en iOS */
            }
            
            /* Bot贸n flotante mejorado */
            .floating-action-btn {
                width: 70px;
                height: 70px;
                bottom: 25px;
                right: 25px;
                font-size: 1.8rem;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            }
            
            /* Header actions en m贸viles */
            .header-actions .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            /* Tabla responsive mejorada */
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .table th, .table td {
                padding: 6px 4px;
            }
            
            /* Grupos de botones en m贸viles */
            .btn-group-mobile {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .btn-group-mobile .btn {
                flex: 1;
                min-width: 80px;
                font-size: 0.8rem;
                padding: 6px 8px;
            }
        }

        /* Orientaci贸n landscape espec铆fica */
        @media (max-width: 768px) and (orientation: landscape) {
            .scanner-content {
                max-height: 95vh;
                overflow-y: auto;
            }
            
            .scanner-frame {
                height: 180px;
            }
            
            .main-content {
                padding-top: 70px;
            }
            
            .navbar {
                padding: 8px 0;
            }
        }

        /* Dispositivos muy peque帽os */
        @media (max-width: 360px) {
            .scanner-content {
                padding: 15px 10px;
            }
            
            .scanner-actions .btn {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .card-body {
                padding: 12px;
            }
        }

        /* Mejoras de accesibilidad t谩ctil */
        @media (hover: none) and (pointer: coarse) {
            .btn, .form-control, .form-select {
                min-height: 44px; /* Tama帽o m铆nimo para toques */
            }
            
            .scan-btn, .location-btn {
                min-height: 38px;
                padding: 10px 15px;
            }
            
            /* Aumentar 谩reas t谩ctiles */
            .nav-link, .table .btn {
                padding: 12px 8px;
            }
        }

        /* Indicadores de capacidades del dispositivo */
        body.is-mobile .scanner-content::before {
            content: " Modo m贸vil activado";
            display: block;
            background: #e7f3ff;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: #0066cc;
        }

        body.no-camera .camera-btn {
            display: none !important;
        }

        body.supports-orientation .scanner-content::after {
            content: " Soporte de orientaci贸n activo";
            display: block;
            background: #f0fff0;
            padding: 5px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #28a745;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="bi bi-building"></i>
                <h1>Skyline</h1>
                <p>Sistema de Solicitudes de Clientes</p>
            </div>
            
            <form id="login-form" class="login-form">
                <div class="mb-3">
                    <label for="login-username" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="login-username" placeholder="Ingrese su usuario" required>
                </div>
                
                <div class="mb-3">
                    <label for="login-password" class="form-label">Contrase帽a</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Ingrese su contrase帽a" required>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="remember-me">
                    <label class="form-check-label" for="remember-me">Recordar sesi贸n</label>
                </div>
                
                <button type="submit" class="btn login-btn" id="login-btn">
                    <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesi贸n
                </button>
                
                <div id="login-error" class="alert alert-danger mt-3" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> <span id="login-error-text"></span>
                </div>
            </form>
            
            <div class="login-footer">
                <small>Skyline &copy; 2024 - Sistema de Gesti贸n de Cr茅ditos</small>
            </div>
        </div>
    </div>

    <!-- Navbar (se mostrar谩 despu茅s del login) -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-building me-2"></i> Skyline
            </a>
            <span class="navbar-text ms-auto d-none d-lg-block">
                Sistema de Solicitudes de Clientes
            </span>
            <div class="user-info ms-3">
                <div class="user-avatar">
                    <i class="bi bi-person"></i>
                </div>
                <span id="current-user">Usuario</span>
                <button class="logout-btn ms-2" id="logout-btn">
                    <i class="bi bi-box-arrow-right"></i> Salir
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content (se mostrar谩 despu茅s del login) -->
    <div class="main-content">
        <!-- Solicitudes Section -->
        <div id="solicitudes" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">Solicitudes de Clientes</h3>
                <div class="header-actions">
                    <button class="btn btn-outline-primary desktop-action-btn" id="refresh-solicitudes-btn">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                    <button class="btn btn-primary desktop-action-btn" data-bs-toggle="modal" data-bs-target="#addSolicitudModal">
                        <i class="bi bi-plus-circle"></i> Nueva Solicitud
                    </button>
                    <button class="btn btn-outline-primary d-lg-none" id="refresh-solicitudes-btn-mobile">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <!-- Informaci贸n del Promotor Actual -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Informaci贸n del Promotor</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="promotor-info">
                                <div class="promotor-info-label">Promotor Actual:</div>
                                <div class="promotor-info-value" id="current-promotor-name">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="promotor-info">
                                <div class="promotor-info-label">Ejecutivo Asignado:</div>
                                <div class="promotor-info-value" id="current-ejecutivo-name">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BUSCADOR DE SOLICITUDES -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">B煤squeda de Solicitudes</h5>
                </div>
                <div class="card-body">
                    <div class="search-container">
                        <input type="text" class="form-control" placeholder="Buscar por nombre, tel茅fono o INE..." id="solicitud-search">
                        <div class="search-results" id="solicitud-search-results"></div>
                    </div>
                </div>
            </div>

            <!-- FILTROS DE ESTADO - Versi贸n m贸vil -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filtrar por Estado</h5>
                </div>
                <div class="card-body p-3">
                    <div class="btn-group-mobile">
                        <button type="button" class="btn btn-outline-secondary active" data-filter="all">
                            Todas
                        </button>
                        <button type="button" class="btn btn-outline-warning" data-filter="pendiente">
                            Pendientes
                        </button>
                        <button type="button" class="btn btn-outline-info" data-filter="revision">
                            En Revisi贸n
                        </button>
                        <button type="button" class="btn btn-outline-success" data-filter="aprobada">
                            Aprobadas
                        </button>
                        <button type="button" class="btn btn-outline-danger" data-filter="rechazada">
                            Rechazadas
                        </button>
                    </div>
                </div>
            </div>

            <!-- LISTA DE SOLICITUDES -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lista de Solicitudes</h5>
                    <div>
                        <span class="badge bg-primary" id="solicitudes-count">0</span>
                        <button class="btn btn-sm btn-outline-primary ms-2 d-none d-md-inline-block" data-bs-toggle="modal" data-bs-target="#addSolicitudModal">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Cliente</th>
                                    <th class="d-none d-md-table-cell">Tel茅fono</th>
                                    <th>Monto</th>
                                    <th class="d-none d-lg-table-cell">Promotor</th>
                                    <th class="d-none d-lg-table-cell">Ejecutivo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="solicitudes-table">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="data-empty py-4">
                                            <i class="bi bi-inbox"></i>
                                            <p>No hay solicitudes registradas</p>
                                            <button class="btn btn-primary desktop-action-btn" data-bs-toggle="modal" data-bs-target="#addSolicitudModal">
                                                <i class="bi bi-plus-circle"></i> Crear primera solicitud
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot贸n flotante para m贸viles -->
    <button class="floating-action-btn d-lg-none" data-bs-toggle="modal" data-bs-target="#addSolicitudModal">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- Add Solicitud Modal - MODIFICADO -->
    <div class="modal fade" id="addSolicitudModal" tabindex="-1" aria-labelledby="addSolicitudModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSolicitudModalLabel">Nueva Solicitud de Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informaci贸n del promotor y ejecutivo asignado -->
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Promotor:</strong> <span id="modal-promotor-name">-</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Ejecutivo Asignado:</strong> <span id="modal-ejecutivo-name">-</span>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs" id="solicitudTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="client-data-tab" data-bs-toggle="tab" data-bs-target="#client-data" type="button" role="tab">
                                <i class="bi bi-person me-1"></i> Datos del Cliente
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="credit-data-tab" data-bs-toggle="tab" data-bs-target="#credit-data" type="button" role="tab">
                                <i class="bi bi-credit-card me-1"></i> Datos del Cr茅dito
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="aval-data-tab" data-bs-toggle="tab" data-bs-target="#aval-data" type="button" role="tab">
                                <i class="bi bi-shield-check me-1"></i> Datos del Aval
                            </button>
                        </li>
                        <!-- NUEVA PESTAA PARA GARANTA Y FACHADA -->
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="guarantee-data-tab" data-bs-toggle="tab" data-bs-target="#guarantee-data" type="button" role="tab">
                                <i class="bi bi-camera me-1"></i> Garant铆a y Fachada
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="solicitudTabsContent">
                        <!-- Pesta帽a Datos del Cliente -->
                        <div class="tab-pane fade show active" id="client-data" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudName" class="form-label">Nombre completo *</label>
                                        <input type="text" class="form-control" id="solicitudName" required>
                                        <div class="invalid-feedback" id="solicitudName-error">Debe ingresar al menos un nombre y un apellido</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudPhone" class="form-label">Tel茅fono *</label>
                                        <input type="tel" class="form-control" id="solicitudPhone" required>
                                        <div class="invalid-feedback" id="solicitudPhone-error">El tel茅fono es obligatorio</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="solicitudAddress" class="form-label">Domicilio completo *</label>
                                <div class="position-relative">
                                    <textarea class="form-control" id="solicitudAddress" rows="3" required></textarea>
                                    <button type="button" class="location-btn" id="get-location-btn">
                                        <i class="bi bi-geo-alt"></i> Ubicaci贸n
                                    </button>
                                </div>
                                <div class="location-status" id="location-status"></div>
                                <div class="invalid-feedback" id="solicitudAddress-error">La direcci贸n es obligatoria</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudCity" class="form-label">Ciudad *</label>
                                        <input type="text" class="form-control" id="solicitudCity" required>
                                        <div class="invalid-feedback" id="solicitudCity-error">La ciudad es obligatoria</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudState" class="form-label">Estado *</label>
                                        <input type="text" class="form-control" id="solicitudState" required>
                                        <div class="invalid-feedback" id="solicitudState-error">El estado es obligatorio</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudINE" class="form-label">N煤mero de INE *</label>
                                        <div class="ine-input-group">
                                            <input type="text" class="form-control" id="solicitudINE" required maxlength="18">
                                            <button type="button" class="scan-btn" data-target="solicitudINE">
                                                <i class="bi bi-camera"></i> Escanear
                                            </button>
                                        </div>
                                        <div class="invalid-feedback" id="solicitudINE-error">El n煤mero de INE es obligatorio</div>
                                        <div class="form-text">Formato: 6 letras + 8 d铆gitos + 3 caracteres (13) o + d铆gito verificador (18)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudFolio" class="form-label">Folio de Pagar茅 *</label>
                                        <input type="text" class="form-control" id="solicitudFolio" required>
                                        <div class="invalid-feedback" id="solicitudFolio-error">El folio de pagar茅 es obligatorio</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pesta帽a Datos del Cr茅dito -->
                        <div class="tab-pane fade" id="credit-data" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudAmount" class="form-label">Monto solicitado *</label>
                                        <input type="number" class="form-control" id="solicitudAmount" required>
                                        <div class="invalid-feedback" id="solicitudAmount-error">El monto solicitado es obligatorio</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudTerm" class="form-label">Plazo solicitado (semanas) *</label>
                                        <input type="number" class="form-control" id="solicitudTerm" value="8" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudRate" class="form-label">Tasa de inter茅s sugerida *</label>
                                        <input type="number" class="form-control" id="solicitudRate" step="0.01" value="12.5" required>
                                        <div class="form-text">Ejemplo: 12.5% para un pago de $625 semanales en un cr茅dito de $5,000</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudPurpose" class="form-label">Prop贸sito del cr茅dito</label>
                                        <textarea class="form-control" id="solicitudPurpose" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="payment-calculation">
                                <h6>C谩lculo del Pago Semanal Estimado</h6>
                                <p id="solicitud-payment-calculation-result">Ingrese el monto y la tasa para ver el c谩lculo</p>
                            </div>
                        </div>
                        
                        <!-- Pesta帽a Datos del Aval -->
                        <div class="tab-pane fade" id="aval-data" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudAvalName" class="form-label">Nombre completo del aval *</label>
                                        <input type="text" class="form-control" id="solicitudAvalName" required>
                                        <div class="invalid-feedback" id="solicitudAvalName-error">El nombre del aval es obligatorio</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudAvalRelationship" class="form-label">Parentesco *</label>
                                        <input type="text" class="form-control" id="solicitudAvalRelationship" required>
                                        <div class="invalid-feedback" id="solicitudAvalRelationship-error">El parentesco del aval es obligatorio</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="solicitudAvalAddress" class="form-label">Domicilio completo del aval *</label>
                                <textarea class="form-control" id="solicitudAvalAddress" rows="3" required></textarea>
                                <div class="invalid-feedback" id="solicitudAvalAddress-error">La direcci贸n del aval es obligatoria</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudAvalPhone" class="form-label">Tel茅fono del aval *</label>
                                        <input type="tel" class="form-control" id="solicitudAvalPhone" required>
                                        <div class="invalid-feedback" id="solicitudAvalPhone-error">El tel茅fono del aval es obligatorio</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="solicitudAvalINE" class="form-label">INE del aval</label>
                                        <div class="ine-input-group">
                                            <input type="text" class="form-control" id="solicitudAvalINE" maxlength="18">
                                            <button type="button" class="scan-btn" data-target="solicitudAvalINE">
                                                <i class="bi bi-camera"></i> Escanear
                                            </button>
                                        </div>
                                        <div class="form-text">Formato: 6 letras + 8 d铆gitos + 3 caracteres (13) o + d铆gito verificador (18)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NUEVA PESTAA: Datos de Garant铆a y Fachada -->
                        <div class="tab-pane fade" id="guarantee-data" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="guaranteeType" class="form-label">Tipo de Garant铆a *</label>
                                        <select class="form-select" id="guaranteeType" required>
                                            <option value="">Seleccione un tipo de garant铆a</option>
                                            <option value="vehiculo">Veh铆culo</option>
                                            <option value="propiedad">Propiedad</option>
                                            <option value="electrodomestico">Electrodom茅stico</option>
                                            <option value="joyeria">Joyer铆a</option>
                                            <option value="otro">Otro</option>
                                        </select>
                                        <div class="invalid-feedback" id="guaranteeType-error">Debe seleccionar un tipo de garant铆a</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Foto de la Garant铆a *</label>
                                        <div class="guarantee-section">
                                            <p>Capture una foto de la garant铆a del cliente o seleccione una desde su galer铆a</p>
                                            <div class="photo-actions">
                                                <button type="button" class="camera-btn" id="capture-guarantee-btn">
                                                    <i class="bi bi-camera"></i> Tomar Foto
                                                </button>
                                                <button type="button" class="upload-btn" id="upload-guarantee-btn">
                                                    <i class="bi bi-upload"></i> Subir Foto
                                                </button>
                                            </div>
                                            <img id="guarantee-preview" class="guarantee-preview" alt="Vista previa de la garant铆a">
                                            <input type="hidden" id="guarantee-photo-data">
                                            <input type="file" id="guarantee-file-input" accept="image/*" style="display: none;">
                                            <div class="invalid-feedback" id="guarantee-photo-error">Debe tomar o subir una foto de la garant铆a</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="guaranteeDescription" class="form-label">Descripci贸n de la Garant铆a</label>
                                        <textarea class="form-control" id="guaranteeDescription" rows="3" placeholder="Describa la garant铆a (marca, modelo, caracter铆sticas, etc.)"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NUEVA SECCIN: Foto de la fachada de la casa -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label class="form-label">Foto de la Fachada de la Casa *</label>
                                        <div class="facade-section">
                                            <p>Capture una foto de la fachada de la casa del cliente o seleccione una desde su galer铆a</p>
                                            <div class="photo-actions">
                                                <button type="button" class="facade-btn" id="capture-facade-btn">
                                                    <i class="bi bi-house"></i> Tomar Foto
                                                </button>
                                                <button type="button" class="upload-btn" id="upload-facade-btn">
                                                    <i class="bi bi-upload"></i> Subir Foto
                                                </button>
                                            </div>
                                            <img id="facade-preview" class="facade-preview" alt="Vista previa de la fachada">
                                            <input type="hidden" id="facade-photo-data">
                                            <input type="file" id="facade-file-input" accept="image/*" style="display: none;">
                                            <div class="invalid-feedback" id="facade-photo-error">Debe tomar o subir una foto de la fachada</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Nota:</strong> Al enviar la solicitud, esta ser谩 autom谩ticamente marcada como "En Revisi贸n" para evaluaci贸n de la garant铆a.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-solicitud-btn">
                        <i class="bi bi-send"></i> Enviar a Revisi贸n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal - MEJORADO -->
    <div class="scanner-container" id="scannerModal">
        <div class="scanner-content">
            <h4 id="scanner-title">Escanear INE</h4>
            <p id="scanner-description">Coloque la INE del cliente dentro del marco</p>
            
            <div class="orientation-indicator">
                <i class="bi bi-phone"></i> Soporte de orientaci贸n activo
            </div>
            
            <div class="scanner-frame">
                <video id="scannerVideo" class="scanner-video" autoplay playsinline></video>
                <canvas id="scannerCanvas" class="scanner-canvas"></canvas>
            </div>
            
            <img id="scannerPreview" class="scanner-preview" alt="Vista previa">
            
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            
            <div class="scanner-actions">
                <button type="button" class="btn btn-secondary" id="cancelScan">Cancelar</button>
                <button type="button" class="btn btn-primary" id="startCamera">Usar C谩mara</button>
                <button type="button" class="btn btn-info" id="uploadPhoto">Subir Foto</button>
                <button type="button" class="btn btn-success" id="capturePhoto" style="display: none;">Capturar</button>
                <button type="button" class="btn btn-warning" id="processImage" style="display: none;">Procesar</button>
                <button type="button" class="btn btn-outline-secondary" id="retryScan" style="display: none;">Intentar de Nuevo</button>
            </div>
            
            <div class="scanner-checkbox">
                <input type="checkbox" id="orientationSupport" checked>
                <label for="orientationSupport">Soporte de orientaci贸n activo</label>
            </div>
            
            <div class="scanner-note" id="scanner-note">
                Nota: El sistema intentar谩 extraer autom谩ticamente el n煤mero de INE, nombre completo, CURP y otros datos
            </div>
            
            <!-- Resultados del escaneo -->
            <div id="scan-results" class="mt-3" style="display: none;">
                <h5>Datos detectados:</h5>
                <div id="extracted-data" class="scan-results-container">
                    <!-- Aqu铆 se mostrar谩n los datos extra铆dos -->
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-success" id="use-extracted-data">
                        <i class="bi bi-check-circle"></i> Usar Datos Detectados
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="manual-entry">
                        <i class="bi bi-pencil"></i> Ingresar Manualmente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Solicitud Modal -->
    <div class="modal fade" id="viewSolicitudModal" tabindex="-1" aria-labelledby="viewSolicitudModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewSolicitudModalLabel">Detalles de la Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h4 id="view-solicitud-name" class="text-primary mb-3"></h4>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge" id="view-solicitud-status">Pendiente</span>
                                <small class="text-muted" id="view-solicitud-fecha"></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informaci贸n del Promotor y Ejecutivo en la vista -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Informaci贸n de Asignaci贸n</h6>
                                </div>
                                <div class="card-body">
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Promotor:</span>
                                        <span id="view-solicitud-promotor"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Ejecutivo:</span>
                                        <span id="view-solicitud-ejecutivo"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Informaci贸n Personal</h6>
                                </div>
                                <div class="card-body">
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Tel茅fono:</span>
                                        <span id="view-solicitud-phone"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Direcci贸n:</span>
                                        <span id="view-solicitud-address"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Ciudad:</span>
                                        <span id="view-solicitud-city"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Estado:</span>
                                        <span id="view-solicitud-state"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">INE:</span>
                                        <span id="view-solicitud-ine"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Folio de Pagar茅:</span>
                                        <span id="view-solicitud-folio"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Informaci贸n de Cr茅dito Solicitado</h6>
                                </div>
                                <div class="card-body">
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Monto Solicitado:</span>
                                        <span id="view-solicitud-amount"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Tasa de Inter茅s:</span>
                                        <span id="view-solicitud-rate"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Plazo:</span>
                                        <span id="view-solicitud-term"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Prop贸sito:</span>
                                        <span id="view-solicitud-purpose"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Pago Semanal Estimado:</span>
                                        <span id="view-solicitud-payment" class="calculation-result"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Informaci贸n del Aval</h6>
                                </div>
                                <div class="card-body">
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Nombre del Aval:</span>
                                        <span id="view-solicitud-aval-name"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Parentesco:</span>
                                        <span id="view-solicitud-aval-relationship"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Tel茅fono del Aval:</span>
                                        <span id="view-solicitud-aval-phone"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Direcci贸n del Aval:</span>
                                        <span id="view-solicitud-aval-address"></span>
                                    </div>
                                    <div class="client-detail-item" id="aval-ine-container" style="display: none;">
                                        <span class="client-detail-label">INE del Aval:</span>
                                        <span id="view-solicitud-aval-ine"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NUEVA SECCIN: Informaci贸n de Garant铆a y Fachada -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Informaci贸n de Garant铆a y Fachada</h6>
                                </div>
                                <div class="card-body">
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Tipo de Garant铆a:</span>
                                        <span id="view-solicitud-guarantee-type"></span>
                                    </div>
                                    <div class="client-detail-item">
                                        <span class="client-detail-label">Descripci贸n:</span>
                                        <span id="view-solicitud-guarantee-description"></span>
                                    </div>
                                    <div class="client-detail-item" id="guarantee-photo-container" style="display: none;">
                                        <span class="client-detail-label">Foto de Garant铆a:</span>
                                        <div>
                                            <img id="view-solicitud-guarantee-photo" class="guarantee-preview" alt="Foto de garant铆a">
                                        </div>
                                    </div>
                                    <div class="client-detail-item" id="facade-photo-container" style="display: none;">
                                        <span class="client-detail-label">Foto de Fachada:</span>
                                        <div>
                                            <img id="view-solicitud-facade-photo" class="facade-preview" alt="Foto de fachada">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIN DE COMENTARIOS Y AUTORIZACIN -->
                    <div class="row mt-4" id="authorization-section" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Autorizaci贸n</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="authorization-comments" class="form-label">Comentarios</label>
                                        <textarea class="form-control" id="authorization-comments" rows="3" placeholder="Ingrese comentarios sobre la solicitud..."></textarea>
                                    </div>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-success" id="approve-solicitud-btn">
                                            <i class="bi bi-check-circle"></i> Aprobar
                                        </button>
                                        <button type="button" class="btn btn-warning" id="review-solicitud-btn">
                                            <i class="bi bi-clock"></i> En Revisi贸n
                                        </button>
                                        <button type="button" class="btn btn-danger" id="reject-solicitud-btn">
                                            <i class="bi bi-x-circle"></i> Rechazar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal para capturar foto de garant铆a -->
    <div class="scanner-container" id="guaranteeCameraModal">
        <div class="scanner-content">
            <h4>Tomar Foto de la Garant铆a</h4>
            <p>Enfoca correctamente la garant铆a para una foto clara</p>
            
            <video id="guaranteeVideo" class="scanner-video" autoplay playsinline></video>
            <canvas id="guaranteeCanvas" class="scanner-canvas"></canvas>
            <img id="guaranteeCameraPreview" class="scanner-preview" alt="Vista previa de garant铆a">
            
            <div class="scanner-actions">
                <button type="button" class="btn btn-secondary" id="cancelGuaranteeCamera">Cancelar</button>
                <button type="button" class="btn btn-primary" id="startGuaranteeCamera">Usar C谩mara</button>
                <button type="button" class="btn btn-success" id="captureGuaranteePhoto" style="display: none;">Tomar Foto</button>
                <button type="button" class="btn btn-outline-secondary" id="retryGuaranteePhoto" style="display: none;">Volver a Tomar</button>
                <button type="button" class="btn btn-warning" id="acceptGuaranteePhoto" style="display: none;">Aceptar Foto</button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal para capturar foto de fachada -->
    <div class="scanner-container" id="facadeCameraModal">
        <div class="scanner-content">
            <h4>Tomar Foto de la Fachada</h4>
            <p>Enfoca correctamente la fachada de la casa para una foto clara</p>
            
            <video id="facadeVideo" class="scanner-video" autoplay playsinline></video>
            <canvas id="facadeCanvas" class="scanner-canvas"></canvas>
            <img id="facadeCameraPreview" class="scanner-preview" alt="Vista previa de fachada">
            
            <div class="scanner-actions">
                <button type="button" class="btn btn-secondary" id="cancelFacadeCamera">Cancelar</button>
                <button type="button" class="btn btn-primary" id="startFacadeCamera">Usar C谩mara</button>
                <button type="button" class="btn btn-success" id="captureFacadePhoto" style="display: none;">Tomar Foto</button>
                <button type="button" class="btn btn-outline-secondary" id="retryFacadePhoto" style="display: none;">Volver a Tomar</button>
                <button type="button" class="btn btn-warning" id="acceptFacadePhoto" style="display: none;">Aceptar Foto</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3f3hOe9sA6WO_rLakRqNk-G6btm5EL94",
            authDomain: "c-j-skyline.firebaseapp.com",
            databaseURL: "https://c-j-skyline-default-rtdb.firebaseio.com",
            projectId: "c-j-skyline",
            storageBucket: "c-j-skyline.firebasestorage.app",
            messagingSenderId: "1008805040336",
            appId: "1:1008805040336:web:70541baf71fdc3e2b08ed5",
            measurementId: "G-MYWR45GG10"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Application state
        let solicitudes = [];
        let executives = [];
        let currentSolicitudId = null;
        let currentScannerTarget = null;
        let scannerStream = null;
        let currentLocation = null;
        let currentUser = null;
        let currentEjecutivo = null;
        let guaranteeStream = null;
        let facadeStream = null;
        let extractedData = {};
        
        // Google Maps configuration
        const GOOGLE_MAPS_API_KEY = 'AIzaSyCDiB_buUrDs9ewFjatWhsuYohos1Q9yfs';
        let googleMapsLoaded = false;
        let autocompleteService;
        let placesService;
        let geocoder;
        let addressAutocomplete;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        // ===== SISTEMA DE GEOLOCALIZACIN MEJORADO =====

        // Funci贸n para cargar la API de Google Maps con tu API key
        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    console.log('Google Maps ya est谩 cargado');
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCDiB_buUrDs9ewFjatWhsuYohos1Q9yfs&libraries=places&callback=initGoogleMapsServices`;
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    console.log('Google Maps API cargada correctamente');
                    resolve();
                };
                
                script.onerror = () => {
                    console.error('Error al cargar Google Maps API');
                    reject(new Error('No se pudo cargar Google Maps API'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Inicializar servicios de Google Maps
        function initGoogleMapsServices() {
            try {
                if (!window.google || !window.google.maps) {
                    console.error('Google Maps no est谩 disponible despu茅s de la carga');
                    updateLocationStatus('error', 'Servicio de mapas no disponible');
                    return false;
                }

                console.log(' Inicializando servicios de Google Maps...');
                
                // Inicializar servicios
                autocompleteService = new google.maps.places.AutocompleteService();
                placesService = new google.maps.places.PlacesService(document.createElement('div'));
                geocoder = new google.maps.Geocoder();
                
                console.log(' Servicios de Google Maps inicializados:', {
                    autocompleteService: !!autocompleteService,
                    placesService: !!placesService,
                    geocoder: !!geocoder
                });
                
                googleMapsLoaded = true;
                
                // Configurar autocompletado para la direcci贸n
                setupAddressAutocomplete();
                
                // Verificar que todo est茅 funcionando
                setTimeout(() => {
                    if (geocoder && addressAutocomplete) {
                        updateLocationStatus('success', ' Servicios de ubicaci贸n listos');
                        console.log(' Todos los servicios de ubicaci贸n est谩n funcionando');
                    } else {
                        updateLocationStatus('warning', '锔 Algunos servicios de ubicaci贸n pueden no estar disponibles');
                    }
                }, 1000);
                
                return true;
                
            } catch (error) {
                console.error(' Error inicializando servicios de Google Maps:', error);
                updateLocationStatus('error', 'Error en servicios de ubicaci贸n');
                return false;
            }
        }

        // Funci贸n mejorada para llenar componentes de la direcci贸n
        function fillAddressComponents(place) {
            let city = '';
            let state = '';
            let postalCode = '';
            
            console.log(' Componentes de direcci贸n encontrados:', place.address_components);
            
            // Buscar componentes de direcci贸n de manera m谩s espec铆fica
            for (const component of place.address_components) {
                const componentType = component.types;
                
                console.log(' Componente:', component.long_name, 'Tipos:', componentType);
                
                // Ciudad/Municipio - prioridad 1
                if (componentType.includes('locality')) {
                    city = component.long_name;
                    console.log(' Ciudad encontrada (locality):', city);
                }
                // Estado
                else if (componentType.includes('administrative_area_level_1')) {
                    state = component.long_name;
                    console.log(' Estado encontrado:', state);
                }
                // C贸digo Postal
                else if (componentType.includes('postal_code')) {
                    postalCode = component.long_name;
                }
                // Municipio - prioridad 2 para ciudad
                else if (componentType.includes('administrative_area_level_2') && !city) {
                    city = component.long_name;
                    console.log(' Ciudad encontrada (level_2):', city);
                }
                // Colonia - prioridad 3 para ciudad
                else if ((componentType.includes('sublocality') || componentType.includes('sublocality_level_1')) && !city) {
                    city = component.long_name;
                    console.log(' Ciudad encontrada (sublocality):', city);
                }
            }
            
            console.log(' Datos finales - Ciudad:', city, 'Estado:', state);
            
            // Actualizar campos del formulario
            if (city) {
                document.getElementById('solicitudCity').value = city;
                document.getElementById('solicitudCity').classList.add('is-valid');
                document.getElementById('solicitudCity').classList.remove('is-invalid');
            } else {
                console.warn('锔 No se pudo detectar la ciudad autom谩ticamente');
                document.getElementById('solicitudCity').classList.add('is-invalid');
            }
            
            if (state) {
                document.getElementById('solicitudState').value = state;
                document.getElementById('solicitudState').classList.add('is-valid');
                document.getElementById('solicitudState').classList.remove('is-invalid');
            } else {
                console.warn('锔 No se pudo detectar el estado autom谩ticamente');
                document.getElementById('solicitudState').classList.add('is-invalid');
            }
            
            // Actualizar estado de ubicaci贸n
            if (city && state) {
                updateLocationStatus('success', `Ubicaci贸n detectada: ${city}, ${state}`);
            } else {
                updateLocationStatus('warning', 'Ubicaci贸n detectada pero algunos datos pueden necesitar ajuste manual');
            }
        }

        // Funci贸n mejorada de geocodificaci贸n inversa
        async function reverseGeocode(lat, lng) {
            return new Promise((resolve, reject) => {
                if (!geocoder) {
                    const error = 'Servicio de geocodificaci贸n no disponible';
                    console.error(error);
                    updateLocationStatus('error', error);
                    reject(new Error(error));
                    return;
                }
                
                const latLng = new google.maps.LatLng(lat, lng);
                
                console.log(' Realizando geocodificaci贸n inversa para:', lat, lng);
                
                geocoder.geocode({ 
                    'location': latLng,
                    'region': 'mx', // Especificar M茅xico para mejores resultados
                    'language': 'es' // Idioma espa帽ol
                }, (results, status) => {
                    console.log(' Respuesta de geocodificaci贸n - Status:', status, 'Resultados:', results);
                    
                    if (status === 'OK' && results[0]) {
                        const address = results[0].formatted_address;
                        console.log(' Direcci贸n completa:', address);
                        
                        document.getElementById('solicitudAddress').value = address;
                        document.getElementById('solicitudAddress').classList.add('is-valid');
                        
                        // Extraer ciudad y estado de manera m谩s precisa
                        fillAddressComponents(results[0]);
                        
                        updateLocationStatus('success', 'Ubicaci贸n convertida a direcci贸n correctamente');
                        resolve(results[0]);
                    } else {
                        let errorMsg = '';
                        switch(status) {
                            case 'ZERO_RESULTS':
                                errorMsg = 'No se encontr贸 direcci贸n para estas coordenadas';
                                break;
                            case 'OVER_QUERY_LIMIT':
                                errorMsg = 'L铆mite de consultas excedido. Intente m谩s tarde';
                                break;
                            case 'REQUEST_DENIED':
                                errorMsg = 'Servicio de geocodificaci贸n denegado';
                                break;
                            case 'INVALID_REQUEST':
                                errorMsg = 'Solicitud de geocodificaci贸n inv谩lida';
                                break;
                            default:
                                errorMsg = 'Error en geocodificaci贸n: ' + status;
                        }
                        
                        console.error(' Error en geocodificaci贸n:', status, errorMsg);
                        updateLocationStatus('error', errorMsg);
                        reject(new Error(errorMsg));
                    }
                });
            });
        }

        // Configuraci贸n mejorada del autocompletado
        function setupAddressAutocomplete() {
            const addressInput = document.getElementById('solicitudAddress');
            
            if (!addressInput) {
                console.error(' No se encontr贸 el input de direcci贸n');
                return;
            }
            
            if (!window.google) {
                console.error(' Google Maps no est谩 disponible');
                return;
            }
            
            try {
                console.log(' Configurando autocompletado de direcciones...');
                
                // Crear autocomplete con opciones espec铆ficas para M茅xico
                addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
                    types: ['address'],
                    componentRestrictions: { 
                        country: 'mx' // Restringir a M茅xico
                    },
                    fields: ['address_components', 'formatted_address', 'geometry', 'name'],
                    language: 'es', // Espa帽ol
                    region: 'mx' // Regi贸n M茅xico
                });
                
                // Escuchar cuando se selecciona una direcci贸n
                addressAutocomplete.addListener('place_changed', function() {
                    const place = addressAutocomplete.getPlace();
                    console.log(' Lugar seleccionado del autocompletado:', place);
                    
                    if (!place.geometry) {
                        console.log(' No se encontraron detalles geom茅tricos del lugar');
                        updateLocationStatus('error', 'No se pudo obtener detalles de la direcci贸n seleccionada');
                        return;
                    }
                    
                    if (!place.address_components || place.address_components.length === 0) {
                        console.log(' No se encontraron componentes de direcci贸n');
                        updateLocationStatus('error', 'Direcci贸n seleccionada no contiene informaci贸n de ubicaci贸n detallada');
                        return;
                    }
                    
                    // Extraer componentes de la direcci贸n de manera m谩s robusta
                    fillAddressComponents(place);
                    
                    // Si tenemos coordenadas, actualizar la ubicaci贸n actual
                    if (place.geometry && place.geometry.location) {
                        currentLocation = {
                            latitude: place.geometry.location.lat(),
                            longitude: place.geometry.location.lng(),
                            accuracy: 50 // Asumir alta precisi贸n para direcciones seleccionadas
                        };
                        console.log(' Ubicaci贸n actualizada desde autocompletado:', currentLocation);
                    }
                    
                    updateLocationStatus('success', 'Direcci贸n seleccionada correctamente');
                });
                
                // Tambi茅n escuchar cambios manuales en el input para geocodificaci贸n
                addressInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        const value = this.value.trim();
                        // Si el input tiene contenido pero no se seleccion贸 un lugar completo,
                        // intentar geocodificar lo que escribi贸 el usuario
                        if (value && value.length > 5 && !this.classList.contains('is-valid')) {
                            console.log(' Intentando geocodificar direcci贸n manual:', value);
                            geocodeAddress(value);
                        }
                    }, 1500);
                });
                
                console.log(' Autocompletado configurado correctamente');
                
            } catch (error) {
                console.error(' Error configurando autocompletado:', error);
                updateLocationStatus('error', 'Error en servicio de direcciones');
            }
        }

        // Funci贸n para geocodificar una direcci贸n manualmente
        function geocodeAddress(address) {
            if (!geocoder) {
                console.error(' Geocoder no disponible');
                return;
            }
            
            console.log(' Geocodificando direcci贸n manual:', address);
            updateLocationStatus('loading', 'Buscando direcci贸n...');
            
            geocoder.geocode({
                'address': address,
                'componentRestrictions': { country: 'mx' },
                'region': 'mx',
                'language': 'es'
            }, (results, status) => {
                console.log(' Respuesta geocodificaci贸n manual - Status:', status, 'Resultados:', results);
                
                if (status === 'OK' && results[0]) {
                    const place = results[0];
                    document.getElementById('solicitudAddress').value = place.formatted_address;
                    document.getElementById('solicitudAddress').classList.add('is-valid');
                    
                    fillAddressComponents(place);
                    
                    // Actualizar ubicaci贸n actual
                    if (place.geometry && place.geometry.location) {
                        currentLocation = {
                            latitude: place.geometry.location.lat(),
                            longitude: place.geometry.location.lng(),
                            accuracy: 100 // Precisi贸n media para geocodificaci贸n
                        };
                    }
                    
                    updateLocationStatus('success', 'Direcci贸n encontrada y validada');
                } else {
                    let errorMsg = 'No se pudo encontrar la direcci贸n ingresada';
                    if (status === 'ZERO_RESULTS') {
                        errorMsg = 'Direcci贸n no encontrada. Verifique que sea correcta';
                    }
                    updateLocationStatus('error', errorMsg);
                    document.getElementById('solicitudAddress').classList.add('is-invalid');
                }
            });
        }

        // Funci贸n mejorada para obtener ubicaci贸n
        function getCurrentLocation() {
            const statusElement = document.getElementById('location-status');
            const locationBtn = document.getElementById('get-location-btn');
            
            if (!navigator.geolocation) {
                updateLocationStatus('error', 'La geolocalizaci贸n no es soportada por este navegador');
                return;
            }
            
            updateLocationStatus('loading', 'Obteniendo ubicaci贸n precisa...');
            
            if (locationBtn) {
                locationBtn.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Obteniendo...';
                locationBtn.disabled = true;
            }
            
            const options = {
                enableHighAccuracy: true, // Mayor precisi贸n
                timeout: 15000, // M谩s tiempo de espera
                maximumAge: 60000
            };
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    console.log('Coordenadas obtenidas:', position.coords);
                    
                    try {
                        await reverseGeocode(position.coords.latitude, position.coords.longitude);
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        // Mostrar precisi贸n obtenida
                        const precision = position.coords.accuracy < 50 ? 'alta' : 
                                         position.coords.accuracy < 100 ? 'media' : 'baja';
                        updateLocationStatus('success', `Ubicaci贸n obtenida (precisi贸n ${precision})`);
                        
                    } catch (error) {
                        console.error('Error en reverse geocoding:', error);
                        updateLocationStatus('error', 'Ubicaci贸n obtenida pero no se pudo determinar la direcci贸n exacta');
                        
                        // Intentar m茅todo alternativo
                        try {
                            const success = await getLocationByIP();
                            if (!success) {
                                updateLocationStatus('error', 'No se pudo determinar la ubicaci贸n autom谩ticamente');
                            }
                        } catch (fallbackError) {
                            updateLocationStatus('error', 'Error al obtener ubicaci贸n: ' + error.message);
                        }
                    } finally {
                        if (locationBtn) {
                            locationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Ubicaci贸n';
                            locationBtn.disabled = false;
                        }
                    }
                },
                (error) => {
                    handleGeolocationError(error);
                    if (locationBtn) {
                        locationBtn.innerHTML = '<i class="bi bi-geo-alt"></i> Ubicaci贸n';
                        locationBtn.disabled = false;
                    }
                },
                options
            );
        }

        // Funci贸n mejorada para manejar errores de geolocalizaci贸n
        function handleGeolocationError(error) {
            let errorMessage = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Permiso de ubicaci贸n denegado. ';
                    errorMessage += 'Por favor, permita el acceso a la ubicaci贸n en la configuraci贸n de her browser. ';
                    errorMessage += 'Como alternativa, puede ingresar manualmente la direcci贸n y usar el autocompletado.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Informaci贸n de ubicaci贸n no disponible. ';
                    errorMessage += 'Verifique su conexi贸n a internet y GPS. ';
                    errorMessage += 'Usando ubicaci贸n aproximada por IP...';
                    
                    // Intentar m茅todo alternativo inmediatamente
                    setTimeout(() => {
                        getLocationByIP();
                    }, 1000);
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Tiempo de espera agotado al obtener la ubicaci贸n. ';
                    errorMessage += 'Verifique su conexi贸n y permisos de ubicaci贸n.';
                    break;
                default:
                    errorMessage = 'Error desconocido al obtener la ubicaci贸n: ' + error.message;
            }
            
            updateLocationStatus('error', errorMessage);
            console.error('Error de geolocalizaci贸n:', error);
        }

        // Funci贸n alternativa mejorada para obtener ubicaci贸n usando IP
        async function getLocationByIP() {
            try {
                updateLocationStatus('loading', 'Obteniendo ubicaci贸n aproximada por IP...');
                
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                console.log('Datos de IP API:', data);
                
                if (data.city && data.region) {
                    const address = `${data.city}, ${data.region}, ${data.country_name}`;
                    document.getElementById('solicitudAddress').value = address;
                    document.getElementById('solicitudCity').value = data.city;
                    document.getElementById('solicitudState').value = data.region;
                    
                    // Marcar campos como v谩lidos
                    document.getElementById('solicitudCity').classList.add('is-valid');
                    document.getElementById('solicitudState').classList.add('is-valid');
                    
                    updateLocationStatus('success', 'Ubicaci贸n aproximada obtenida por IP');
                    return true;
                }
            } catch (error) {
                console.error('Error obteniendo ubicaci贸n por IP:', error);
                updateLocationStatus('error', 'No se pudo obtener ubicaci贸n aproximada');
            }
            
            return false;
        }

        // Inicializaci贸n mejorada de Google Maps
        function initializeGoogleMapsWithRetry(retries = 3) {
            if (retries <= 0) {
                console.error(' No se pudo cargar Google Maps despu茅s de varios intentos');
                updateLocationStatus('error', 'Servicio de mapas no disponible. Ingrese la direcci贸n manualmente.');
                return;
            }
            
            console.log(` Intentando cargar Google Maps (intento ${4 - retries}/3)...`);
            
            loadGoogleMapsAPI().then(() => {
                console.log(' Google Maps API cargada, inicializando servicios...');
                
                // Dar tiempo a que se inicialice el callback
                setTimeout(() => {
                    // Verificar manualmente si los servicios est谩n listos
                    if (window.google && window.google.maps) {
                        console.log(' Google Maps est谩 disponible');
                        initGoogleMapsServices();
                    } else {
                        console.log(' Google Maps no est谩 listo, reintentando...');
                        initializeGoogleMapsWithRetry(retries - 1);
                    }
                }, 2000);
                
            }).catch(error => {
                console.error(` Intento ${4 - retries} fall贸:`, error);
                setTimeout(() => {
                    initializeGoogleMapsWithRetry(retries - 1);
                }, 3000);
            });
        }

        // Actualizar estado de la ubicaci贸n en la UI
        function updateLocationStatus(type, message) {
            const statusElement = document.getElementById('location-status');
            
            // Limpiar clases anteriores
            statusElement.className = 'location-status';
            
            // Agregar clase seg煤n el tipo
            statusElement.classList.add(`location-${type}`);
            
            // Actualizar contenido
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="bi bi-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="bi bi-exclamation-circle"></i>';
                    break;
                case 'loading':
                    icon = '<span class="loading-spinner"></span>';
                    break;
                case 'warning':
                    icon = '<i class="bi bi-exclamation-triangle"></i>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} ${message}`;
        }

        // ===== SISTEMA DE ESCANER COMPLETO =====

        // Configuraci贸n mejorada del scanner
        function setupScanner() {
            document.querySelectorAll('.scan-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    openScanner(target);
                });
            });
            
            document.getElementById('cancelScan').addEventListener('click', closeScanner);
            document.getElementById('startCamera').addEventListener('click', startCamera);
            document.getElementById('uploadPhoto').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('capturePhoto').addEventListener('click', capturePhoto);
            document.getElementById('processImage').addEventListener('click', processImageWithOCR);
            document.getElementById('retryScan').addEventListener('click', function() {
                resetScannerUI();
                document.getElementById('scannerPreview').src = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('scan-results').style.display = 'none';
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            document.getElementById('use-extracted-data').addEventListener('click', useExtractedData);
            document.getElementById('manual-entry').addEventListener('click', closeScanner);
            
            // Configurar soporte de orientaci贸n
            setupOrientationSupport();
        }

        // Configurar soporte de orientaci贸n
        function setupOrientationSupport() {
            const checkbox = document.getElementById('orientationSupport');
            const scannerModal = document.getElementById('scannerModal');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    scannerModal.classList.add('active');
                } else {
                    scannerModal.classList.remove('active');
                }
            });
            
            // Detectar cambios de orientaci贸n
            if (screen.orientation) {
                screen.orientation.addEventListener('change', handleOrientationChange);
            } else {
                window.addEventListener('orientationchange', handleOrientationChange);
            }
        }

        // Manejar cambios de orientaci贸n
        function handleOrientationChange() {
            const scannerModal = document.getElementById('scannerModal');
            if (!scannerModal.style.display || scannerModal.style.display === 'none') return;
            
            // Reconfigurar la c谩mara si est谩 activa
            if (scannerStream) {
                setTimeout(() => {
                    stopCamera();
                    startCamera();
                }, 300);
            }
        }

        // Funci贸n mejorada para abrir el scanner
        function openScanner(target) {
            currentScannerTarget = target;
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.style.display = 'flex';
            resetScannerUI();
            
            const title = document.getElementById('scanner-title');
            const description = document.getElementById('scanner-description');
            const note = document.getElementById('scanner-note');
            
            if (target === 'solicitudINE') {
                title.textContent = 'Escanear INE del Cliente';
                description.textContent = 'Coloque la INE del cliente dentro del marco';
                note.textContent = 'Nota: El sistema intentar谩 extraer autom谩ticamente el n煤mero de INE y nombre del cliente';
            } else if (target === 'solicitudAvalINE') {
                title.textContent = 'Escanear INE del Aval';
                description.textContent = 'Coloque la INE del aval dentro del marco';
                note.textContent = 'Nota: El sistema intentar谩 extraer autom谩ticamente el n煤mero de INE y nombre del aval';
            }
            
            // Activar soporte de orientaci贸n si est谩 marcado
            const checkbox = document.getElementById('orientationSupport');
            if (checkbox.checked) {
                scannerModal.classList.add('active');
            }
        }
        
        // Funci贸n mejorada para cerrar el scanner
        function closeScanner() {
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.style.display = 'none';
            scannerModal.classList.remove('capturing', 'processing');
            stopCamera();
            resetScannerUI();
            document.getElementById('scannerPreview').src = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('scan-results').style.display = 'none';
        }
        
        // Funci贸n mejorada para resetear la UI del scanner
        function resetScannerUI() {
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.classList.remove('capturing', 'processing');
            
            document.getElementById('scannerVideo').style.display = 'none';
            document.getElementById('scannerPreview').style.display = 'none';
            document.getElementById('startCamera').style.display = 'inline-block';
            document.getElementById('uploadPhoto').style.display = 'inline-block';
            document.getElementById('capturePhoto').style.display = 'none';
            document.getElementById('processImage').style.display = 'none';
            document.getElementById('retryScan').style.display = 'none';
        }
        
        // Funci贸n mejorada para mostrar botones de procesamiento
        function showProcessingButtons() {
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.classList.remove('capturing');
            scannerModal.classList.add('processing');
            
            document.getElementById('startCamera').style.display = 'none';
            document.getElementById('uploadPhoto').style.display = 'none';
            document.getElementById('capturePhoto').style.display = 'none';
            document.getElementById('processImage').style.display = 'inline-block';
            document.getElementById('retryScan').style.display = 'inline-block';
        }
        
        // Funci贸n mejorada para iniciar la c谩mara
        async function startCamera() {
            try {
                const scannerModal = document.getElementById('scannerModal');
                scannerModal.classList.add('capturing');
                
                // Primero intentar con la c谩mara trasera (environment)
                let constraints = { 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                };
                
                try {
                    scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (error) {
                    console.log('C谩mara trasera no disponible, intentando con frontal');
                    // Si falla, intentar con la c谩mara frontal
                    constraints.video.facingMode = 'user';
                    scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                
                const video = document.getElementById('scannerVideo');
                video.srcObject = scannerStream;
                video.style.display = 'block';
                
                // Configurar para escanear en cualquier orientaci贸n
                video.style.transform = 'scaleX(-1)'; // Espejo para mejor experiencia
                video.setAttribute('playsinline', 'true');
                
                // Ajustar seg煤n la orientaci贸n del dispositivo
                setupCameraOrientation();
                
                document.getElementById('startCamera').style.display = 'none';
                document.getElementById('uploadPhoto').style.display = 'none';
                document.getElementById('capturePhoto').style.display = 'inline-block';
                document.getElementById('retryScan').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Error al acceder a la c谩mara:', error);
                showCameraError(error);
            }
        }

        // Configurar orientaci贸n de la c谩mara seg煤n el dispositivo
        function setupCameraOrientation() {
            const video = document.getElementById('scannerVideo');
            const checkbox = document.getElementById('orientationSupport');
            
            if (!checkbox.checked) return;
            
            function handleOrientation() {
                const orientation = window.screen.orientation || window.orientation;
                
                if (window.screen.orientation) {
                    switch(window.screen.orientation.type) {
                        case 'landscape-primary':
                            video.style.transform = 'scaleX(-1)';
                            break;
                        case 'landscape-secondary':
                            video.style.transform = 'scaleX(1)';
                            break;
                        case 'portrait-primary':
                        case 'portrait-secondary':
                            video.style.transform = 'scaleX(-1)';
                            break;
                    }
                } else if (window.orientation) {
                    switch(window.orientation) {
                        case 0: // Portrait
                        case 180: // Portrait upside down
                            video.style.transform = 'scaleX(-1)';
                            break;
                        case 90: // Landscape left
                        case -90: // Landscape right
                            video.style.transform = 'scaleX(1)';
                            break;
                    }
                }
            }
            
            // Escuchar cambios de orientaci贸n
            window.addEventListener('orientationchange', handleOrientation);
            if (screen.orientation) {
                screen.orientation.addEventListener('change', handleOrientation);
            }
            
            handleOrientation(); // Configurar inicialmente
        }

        // Manejo mejorado de errores de c谩mara
        function showCameraError(error) {
            let errorMessage = 'No se pudo acceder a la c谩mara. ';
            
            switch(error.name) {
                case 'NotAllowedError':
                    errorMessage += 'Por favor, permita el acceso a la c谩mara en la configuraci贸n de su navegador.';
                    break;
                case 'NotFoundError':
                    errorMessage += 'No se encontr贸 ninguna c谩mara disponible.';
                    break;
                case 'NotSupportedError':
                    errorMessage += 'Su navegador no soporta el acceso a la c谩mara.';
                    break;
                case 'NotReadableError':
                    errorMessage += 'La c谩mara est谩 siendo usada por otra aplicaci贸n.';
                    break;
                default:
                    errorMessage += 'Error desconocido: ' + error.message;
            }
            
            // Mostrar opciones alternativas
            const scannerContent = document.querySelector('.scanner-content');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning mt-3';
            errorDiv.innerHTML = `
                <strong>锔 ${errorMessage}</strong>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" id="retry-camera">
                        <i class="bi bi-arrow-clockwise"></i> Reintentar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="use-upload">
                        <i class="bi bi-upload"></i> Subir Foto
                    </button>
                </div>
            `;
            
            scannerContent.appendChild(errorDiv);
            
            document.getElementById('retry-camera').addEventListener('click', function() {
                errorDiv.remove();
                startCamera();
            });
            
            document.getElementById('use-upload').addEventListener('click', function() {
                errorDiv.remove();
                document.getElementById('fileInput').click();
            });
        }
        
        function stopCamera() {
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
        }
        
        function capturePhoto() {
            const scannerModal = document.getElementById('scannerModal');
            scannerModal.classList.remove('capturing');
            
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            const preview = document.getElementById('scannerPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            preview.src = canvas.toDataURL('image/png');
            preview.style.display = 'block';
            
            showProcessingButtons();
            stopCamera();
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const preview = document.getElementById('scannerPreview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                showProcessingButtons();
            }
        }

        // ===== SISTEMA MEJORADO DE DETECCIN PARA INES MEXICANAS =====

        // Funci贸n principal mejorada para procesar INEs en cualquier orientaci贸n
        async function processImageWithOCR() {
            const preview = document.getElementById('scannerPreview');
            const processBtn = document.getElementById('processImage');
            
            processBtn.innerHTML = '<span class="loading-spinner"></span> Procesando INE...';
            processBtn.disabled = true;
            
            try {
                // Detectar orientaci贸n y rotar si es necesario
                const rotatedImage = await detectAndRotateImage(preview);
                
                const { data: { text } } = await Tesseract.recognize(
                    rotatedImage,
                    'spa',
                    { 
                        logger: m => console.log(m),
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD, // Detecci贸n autom谩tica de orientaci贸n
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 /-.,'
                    }
                );
                
                console.log('Texto extra铆do completo:', text);
                
                // Reiniciar datos extra铆dos
                extractedData = {};
                
                // Procesar el texto para extraer informaci贸n espec铆fica de INE mexicana
                const processedData = processINEtext(text);
                
                // Mostrar resultados
                displayExtractedData(processedData);
                
            } catch (error) {
                console.error('Error en OCR:', error);
                alert('Error al procesar la imagen. Por favor, intente nuevamente o ingrese los datos manualmente.');
            } finally {
                processBtn.innerHTML = 'Procesar';
                processBtn.disabled = false;
            }
        }

        // Funci贸n para detectar y rotar la imagen seg煤n la orientaci贸n
        function detectAndRotateImage(imgElement) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Crear una nueva imagen para trabajar
                const img = new Image();
                img.onload = function() {
                    const width = img.width;
                    const height = img.height;
                    
                    // Detectar orientaci贸n basada en dimensiones
                    const isLandscape = width > height;
                    
                    if (isLandscape) {
                        // Ya est谩 en horizontal, usar como est谩
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0);
                    } else {
                        // Rotar a horizontal
                        canvas.width = height;
                        canvas.height = width;
                        ctx.translate(height / 2, width / 2);
                        ctx.rotate(Math.PI / 2);
                        ctx.drawImage(img, -width / 2, -height / 2);
                    }
                    
                    resolve(canvas.toDataURL('image/png'));
                };
                
                img.src = imgElement.src;
            });
        }

        // Funci贸n mejorada para procesar texto de INE mexicana
        function processINEtext(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const result = {
                nombre: null,
                ine: null,
                curp: null,
                fechaNacimiento: null,
                sexo: null,
                direccion: null,
                vigencia: null,
                emision: null,
                debug: {
                    lines: lines,
                    patterns: {}
                }
            };

            console.log('Procesando', lines.length, 'l铆neas de texto');

            // Estrategias de extracci贸n mejoradas
            extractNameFromINE(lines, result);
            extractINEnumber(lines, result);
            extractCURP(lines, result);
            extractBirthDate(lines, result);
            extractSex(lines, result);
            extractAddress(lines, result);
            extractDates(lines, result);

            return result;
        }

        // Extracci贸n de nombre con patrones espec铆ficos para INE mexicana
        function extractNameFromINE(lines, result) {
            const namePatterns = [
                // Patr贸n: despu茅s de "NOMBRE" o variantes
                { pattern: /NOMBRE\s*([A-Z\s]{10,50})/i, group: 1 },
                // Patr贸n: l铆nea que contiene m煤ltiples palabras en may煤sculas (apellidos + nombres)
                { pattern: /^[A-Z]{2,}(?:\s+[A-Z]{2,}){2,}$/ },
                // Buscar l铆neas que parezcan nombres completos
                { pattern: /^[A-Z\s]{10,40}$/ }
            ];

            for (let patternConfig of namePatterns) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const match = line.match(patternConfig.pattern);
                    
                    if (match) {
                        let nameCandidate = patternConfig.group ? match[patternConfig.group] : match[0];
                        nameCandidate = nameCandidate.trim();
                        
                        // Validar que sea un nombre v谩lido (m铆nimo 3 palabras, sin n煤meros)
                        if (isValidMexicanName(nameCandidate)) {
                            result.nombre = formatMexicanName(nameCandidate);
                            result.debug.patterns.nombre = {
                                pattern: patternConfig.pattern.toString(),
                                line: i,
                                match: nameCandidate
                            };
                            console.log('Nombre detectado:', result.nombre);
                            return;
                        }
                    }
                }
            }

            // Estrategia de respaldo: buscar la l铆nea m谩s larga que parezca un nombre
            let longestNameCandidate = '';
            for (let line of lines) {
                if (isValidMexicanName(line) && line.length > longestNameCandidate.length) {
                    longestNameCandidate = line;
                }
            }
            
            if (longestNameCandidate) {
                result.nombre = formatMexicanName(longestNameCandidate);
                result.debug.patterns.nombre = { fallback: longestNameCandidate };
            }
        }

        // Validar nombre mexicano (apellido paterno + apellido materno + nombre(s))
        function isValidMexicanName(text) {
            if (!text || text.length < 8) return false;
            
            const words = text.trim().split(/\s+/);
            if (words.length < 3) return false;
            
            // Debe contener solo letras y espacios
            if (!/^[A-Z\s]+$/.test(text)) return false;
            
            // No debe contener n煤meros
            if (/\d/.test(text)) return false;
            
            // No debe ser una palabra com煤n de documentos
            if (isCommonDocumentWord(text)) return false;
            
            // Cada palabra debe tener al menos 2 caracteres
            for (let word of words) {
                if (word.length < 2) return false;
            }
            
            return true;
        }

        // Formatear nombre en formato mexicano est谩ndar
        function formatMexicanName(fullName) {
            return fullName
                .trim()
                .toUpperCase()
                .replace(/\s+/g, ' ')
                .replace(/\b(DE|LA|DEL|LOS|LAS|Y|E)\b/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Extraer n煤mero de INE
        function extractINEnumber(lines, result) {
            const inePatterns = [
                /CLAVE\s*DE\s*ELECTOR\s*[:]?\s*([A-Z0-9]{13,18})/i,
                /CREDENCIAL\s*[:]?\s*([A-Z0-9]{13,18})/i,
                /ELECTOR\s*[:]?\s*([A-Z0-9]{13,18})/i,
                /INE\s*[:]?\s*([A-Z0-9]{13,18})/i,
                /([A-Z]{6}[0-9]{8}[A-Z0-9]{3,5})/,
                /([A-Z0-9]{13})/,
                /([A-Z0-9]{18})/
            ];

            for (let pattern of inePatterns) {
                for (let line of lines) {
                    const matches = line.match(pattern);
                    if (matches) {
                        const ineCandidate = matches[1] || matches[0];
                        const cleanedINE = ineCandidate.replace(/[^A-Z0-9]/g, '');
                        
                        if (cleanedINE.length === 13 || cleanedINE.length === 18) {
                            result.ine = cleanedINE;
                            result.debug.patterns.ine = {
                                pattern: pattern.toString(),
                                match: cleanedINE
                            };
                            console.log('INE detectado:', result.ine);
                            return;
                        }
                    }
                }
            }
        }

        // Extraer CURP
        function extractCURP(lines, result) {
            const curpPattern = /([A-Z]{4}[0-9]{6}[A-Z]{6}[0-9A-Z]{2})/;
            
            for (let line of lines) {
                const match = line.match(curpPattern);
                if (match) {
                    result.curp = match[1];
                    result.debug.patterns.curp = { match: result.curp };
                    console.log('CURP detectado:', result.curp);
                    return;
                }
            }
        }

        // Extraer fecha de nacimiento
        function extractBirthDate(lines, result) {
            const datePatterns = [
                /FECHA\s*DE\s*NACIMIENTO\s*[:]?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /NACIMIENTO\s*[:]?\s*(\d{1,2}\/\d{1,2}\/\d{4})/i,
                /(\d{1,2}\/\d{1,2}\/\d{4})/
            ];

            for (let pattern of datePatterns) {
                for (let line of lines) {
                    const match = line.match(pattern);
                    if (match) {
                        const dateCandidate = match[1];
                        if (isValidDate(dateCandidate)) {
                            result.fechaNacimiento = dateCandidate;
                            result.debug.patterns.fechaNacimiento = {
                                pattern: pattern.toString(),
                                match: dateCandidate
                            };
                            console.log('Fecha nacimiento detectada:', result.fechaNacimiento);
                            return;
                        }
                    }
                }
            }
        }

        // Extraer sexo
        function extractSex(lines, result) {
            const sexPatterns = [
                /SEXO\s*[:]?\s*([MH])/i,
                /SEXO\s*[:]?\s*(MASCULINO|FEMENINO)/i,
                /([MH])\s*SEXO/i
            ];

            for (let pattern of sexPatterns) {
                for (let line of lines) {
                    const match = line.match(pattern);
                    if (match) {
                        let sex = match[1].toUpperCase();
                        if (sex === 'MASCULINO') sex = 'H';
                        if (sex === 'FEMENINO') sex = 'M';
                        
                        result.sexo = sex;
                        result.debug.patterns.sexo = {
                            pattern: pattern.toString(),
                            match: sex
                        };
                        console.log('Sexo detectado:', result.sexo);
                        return;
                    }
                }
            }
        }

        // Extraer direcci贸n
        function extractAddress(lines, result) {
            // Buscar despu茅s de "DOMICILIO" o "DIRECCIN"
            const addressKeywords = ['DOMICILIO', 'DIRECCION', 'DIRECCIN'];
            
            for (let keyword of addressKeywords) {
                const joinedText = lines.join(' ');
                const keywordIndex = joinedText.indexOf(keyword);
                
                if (keywordIndex !== -1) {
                    const textAfterKeyword = joinedText.substring(keywordIndex + keyword.length, keywordIndex + keyword.length + 100);
                    // Tomar un fragmento razonable despu茅s de la palabra clave
                    result.direccion = textAfterKeyword.trim().substring(0, 80);
                    result.debug.patterns.direccion = {
                        keyword: keyword,
                        fragment: result.direccion
                    };
                    console.log('Direcci贸n detectada:', result.direccion);
                    return;
                }
            }
        }

        // Extraer fechas de emisi贸n y vigencia
        function extractDates(lines, result) {
            const dateKeywords = [
                { key: 'emision', patterns: ['EMISION', 'EXPEDICION'] },
                { key: 'vigencia', patterns: ['VIGENCIA', 'VALIDA HASTA'] }
            ];

            for (let dateConfig of dateKeywords) {
                for (let pattern of dateConfig.patterns) {
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes(pattern)) {
                            // Buscar a帽o en la misma l铆nea o siguiente
                            const yearMatch = lines[i].match(/(20\d{2})/);
                            if (yearMatch) {
                                result[dateConfig.key] = yearMatch[1];
                                result.debug.patterns[dateConfig.key] = {
                                    pattern: pattern,
                                    year: result[dateConfig.key]
                                };
                                console.log(`${dateConfig.key} detectada:`, result[dateConfig.key]);
                                break;
                            }
                        }
                    }
                    if (result[dateConfig.key]) break;
                }
            }
        }

        // Validar fecha
        function isValidDate(dateString) {
            const parts = dateString.split('/');
            if (parts.length !== 3) return false;
            
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const year = parseInt(parts[2]);
            
            if (day < 1 || day > 31) return false;
            if (month < 1 || month > 12) return false;
            if (year < 1900 || year > new Date().getFullYear()) return false;
            
            return true;
        }

        // Palabras comunes de documentos (no nombres)
        function isCommonDocumentWord(text) {
            const commonWords = [
                'INSTITUTO', 'NACIONAL', 'ELECTORAL', 'CREDENCIAL', 'IDENTIDAD',
                'CLAVE', 'ELECTOR', 'FECHA', 'EXPEDICION', 'VIGENCIA', 'DOMICILIO',
                'SECRETARIA', 'GOBIERNO', 'ESTADO', 'MEXICANO', 'NACIMIENTO',
                'SEXO', 'AO', 'EJIDO', 'COLONIA', 'CP', 'CURP', 'RFC', 'IFE',
                'VIGENTE', 'HASTA', 'EMISION', 'LOCALIDAD', 'MUNICIPIO', 'SECTOR',
                'MANZANA', 'LOTE', 'REGISTRO', 'FOLIO', 'DOCUMENTO', 'OFICIAL',
                'MUESTRA', 'MXICO', 'REGISTRO', 'FEDERAL', 'ELECTORES'
            ];
            
            const words = text.split(' ');
            return words.some(word => commonWords.includes(word));
        }

        // Mostrar datos extra铆dos de forma mejorada
        async function displayExtractedData(data) {
            const resultsContainer = document.getElementById('scan-results');
            const extractedDataDiv = document.getElementById('extracted-data');
            
            let resultsHTML = '<div class="scan-results-container">';
            
            // Nombre
            if (data.nombre) {
                resultsHTML += `
                    <div class="scan-result-item">
                        <strong> Nombre completo:</strong> 
                        <span class="data-highlight">${data.nombre}</span>
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div class="scan-result-item scan-result-warning">
                        <strong>锔 Nombre:</strong> No detectado autom谩ticamente
                    </div>
                `;
            }
            
            // INE
            if (data.ine) {
                const validacion = validarFormatoINE(data.ine);
                if (validacion.valido) {
                    resultsHTML += `
                        <div class="scan-result-item">
                            <strong> INE:</strong> 
                            <span class="data-highlight">${data.ine}</span> 
                            <small>(${validacion.formato})</small>
                        </div>
                    `;
                } else {
                    resultsHTML += `
                        <div class="scan-result-item scan-result-warning">
                            <strong>锔 INE:</strong> ${data.ine} <small>(formato inv谩lido)</small>
                        </div>
                    `;
                }
            } else {
                resultsHTML += `
                    <div class="scan-result-item scan-result-warning">
                        <strong>锔 INE:</strong> No detectado
                    </div>
                `;
            }
            
            // CURP
            if (data.curp) {
                resultsHTML += `
                    <div class="scan-result-item">
                        <strong> CURP:</strong> 
                        <span class="data-highlight">${data.curp}</span>
                    </div>
                `;
            }
            
            // Fecha de nacimiento
            if (data.fechaNacimiento) {
                resultsHTML += `
                    <div class="scan-result-item">
                        <strong> Fecha de nacimiento:</strong> 
                        <span class="data-highlight">${data.fechaNacimiento}</span>
                    </div>
                `;
            }
            
            // Sexo
            if (data.sexo) {
                const sexoText = data.sexo === 'M' ? 'Femenino' : 'Masculino';
                resultsHTML += `
                    <div class="scan-result-item">
                        <strong> Sexo:</strong> 
                        <span class="data-highlight">${sexoText}</span>
                    </div>
                `;
            }
            
            // Validaciones autom谩ticas
            resultsHTML += `<div class="mt-3 p-2 border rounded">`;
            resultsHTML += `<h6> Validaciones Autom谩ticas:</h6>`;
            
            if (data.nombre && data.ine) {
                // Verificar lista negra
                const listaNegra = await verificarListaNegra(data.ine, data.nombre);
                if (listaNegra.enListaNegra) {
                    resultsHTML += `
                        <div class="scan-result-item scan-result-error">
                            <strong> CLIENTE EN LISTA NEGRA</strong><br>
                            <small>Motivo: ${listaNegra.motivo}</small>
                        </div>
                    `;
                } else {
                    resultsHTML += `
                        <div class="scan-result-item">
                            <strong> No est谩 en lista negra</strong>
                        </div>
                    `;
                }
                
                // Verificar si ya est谩 registrado
                const clienteRegistrado = await verificarClienteRegistrado(data.ine, data.nombre);
                if (clienteRegistrado.registrado) {
                    let warningHTML = `
                        <div class="scan-result-item scan-result-warning">
                            <strong>锔 CLIENTE YA REGISTRADO</strong>
                    `;
                    
                    if (clienteRegistrado.solicitudesPendientes.length > 0) {
                        warningHTML += `<br><small>Tiene ${clienteRegistrado.solicitudesPendientes.length} cr茅dito(s) pendiente(s)</small>`;
                    }
                    
                    warningHTML += `</div>`;
                    resultsHTML += warningHTML;
                } else {
                    resultsHTML += `
                        <div class="scan-result-item">
                            <strong> Cliente no registrado anteriormente</strong>
                        </div>
                    `;
                }
            }
            
            resultsHTML += `</div>`;
            
            // Informaci贸n de debug (solo en desarrollo)
            if (false) { // Cambiar a true para debug
                resultsHTML += `
                    <details class="mt-2">
                        <summary>Informaci贸n de depuraci贸n</summary>
                        <div class="extraction-debug">
                            <strong>L铆neas detectadas (${data.debug.lines.length}):</strong>
                            <pre>${data.debug.lines.join('\n')}</pre>
                            <strong>Patrones usados:</strong>
                            <pre>${JSON.stringify(data.debug.patterns, null, 2)}</pre>
                        </div>
                    </details>
                `;
            }
            
            resultsHTML += '</div>';
            
            extractedDataDiv.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';
            extractedData = data;
            
            document.getElementById('scanner-note').textContent = 
                'Revise los datos detectados antes de continuar';
        }

        // ===== FUNCIN MEJORADA PARA USAR DATOS EXTRADOS =====

        function useExtractedData() {
            if (extractedData.ine) {
                document.getElementById(currentScannerTarget).value = extractedData.ine;
                
                // Si estamos escaneando el INE del cliente
                if (currentScannerTarget === 'solicitudINE') {
                    if (extractedData.nombre) {
                        document.getElementById('solicitudName').value = extractedData.nombre;
                    }
                    
                    // Mostrar notificaciones de validaci贸n
                    setTimeout(async () => {
                        if (extractedData.ine && extractedData.nombre) {
                            const listaNegra = await verificarListaNegra(extractedData.ine, extractedData.nombre);
                            if (listaNegra.enListaNegra) {
                                mostrarNotificacion(
                                    'CLIENTE EN LISTA NEGRA', 
                                    `Motivo: ${listaNegra.motivo}\nEste cliente no puede realizar solicitudes.`,
                                    'danger'
                                );
                            }
                            
                            const clienteRegistrado = await verificarClienteRegistrado(extractedData.ine, extractedData.nombre);
                            if (clienteRegistrado.registrado) {
                                let mensaje = 'Cliente ya registrado en el sistema.';
                                if (clienteRegistrado.solicitudesPendientes.length > 0) {
                                    mensaje += ` Tiene ${clienteRegistrado.solicitudesPendientes.length} cr茅dito(s) pendiente(s).`;
                                }
                                mostrarNotificacion('CLIENTE DUPLICADO', mensaje, 'warning');
                            }
                        }
                    }, 500);
                }
                
                // Si estamos escaneando el INE del aval
                if (currentScannerTarget === 'solicitudAvalINE' && extractedData.nombre) {
                    document.getElementById('solicitudAvalName').value = extractedData.nombre;
                }
            }
            
            closeScanner();
        }

        // ===== FUNCIONES DE VALIDACIN =====

        async function verificarListaNegra(ine, nombre) {
            try {
                const snapshot = await database.ref('listaNegra').once('value');
                const listaNegra = snapshot.val();
                
                if (!listaNegra) return { enListaNegra: false };
                
                for (const [id, cliente] of Object.entries(listaNegra)) {
                    const ineCoincide = cliente.ine && 
                        cliente.ine.trim().toUpperCase() === ine.trim().toUpperCase();
                    const nombreCoincide = cliente.nombre && 
                        normalizarNombre(cliente.nombre) === normalizarNombre(nombre);
                    
                    if (ineCoincide || nombreCoincide) {
                        return {
                            enListaNegra: true,
                            motivo: cliente.motivo || 'Cliente en lista negra',
                            fechaRegistro: cliente.fechaRegistro
                        };
                    }
                }
                
                return { enListaNegra: false };
            } catch (error) {
                console.error('Error verificando lista negra:', error);
                return { enListaNegra: false };
            }
        }

        async function verificarClienteRegistrado(ine, nombre) {
            try {
                const snapshot = await database.ref('solicitudes').once('value');
                const todasSolicitudes = snapshot.val();
                
                if (!todasSolicitudes) return { registrado: false, solicitudesPendientes: [] };
                
                let clienteRegistrado = false;
                let solicitudesPendientes = [];
                let infoCliente = null;
                
                for (const [solicitudId, solicitud] of Object.entries(todasSolicitudes)) {
                    const ineCoincide = solicitud.ine && 
                        solicitud.ine.trim().toUpperCase() === ine.trim().toUpperCase();
                    const nombreCoincide = solicitud.nombre && 
                        normalizarNombre(solicitud.nombre) === normalizarNombre(nombre);
                    
                    if (ineCoincide || nombreCoincide) {
                        clienteRegistrado = true;
                        infoCliente = solicitud;
                        
                        if (solicitud.estado === 'pendiente' || solicitud.estado === 'revision') {
                            solicitudesPendientes.push({
                                id: solicitudId,
                                monto: solicitud.monto,
                                estado: solicitud.estado,
                                fecha: solicitud.fechaSolicitud
                            });
                        }
                    }
                }
                
                return {
                    registrado: clienteRegistrado,
                    solicitudesPendientes: solicitudesPendientes,
                    infoCliente: infoCliente
                };
            } catch (error) {
                console.error('Error verificando cliente registrado:', error);
                return { registrado: false, solicitudesPendientes: [] };
            }
        }

        function normalizarNombre(nombre) {
            return nombre
                .trim()
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, ' ')
                .replace(/[^a-z\s]/g, '');
        }

        function mostrarNotificacion(titulo, mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            notificacion.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 500px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            notificacion.innerHTML = `
                <strong>${titulo}</strong>
                <div>${mensaje}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 8000);
        }

        // ===== SISTEMA DE LOGIN =====

        function checkExistingSession() {
            const savedUser = localStorage.getItem('skyline_user');
            const savedPassword = localStorage.getItem('skyline_password');
            
            if (savedUser && savedPassword) {
                document.getElementById('login-username').value = savedUser;
                document.getElementById('login-password').value = savedPassword;
                document.getElementById('remember-me').checked = true;
            }
        }

        async function loginUser(username, password) {
            try {
                showLoginLoading(true);
                
                const snapshot = await database.ref('promotoras').once('value');
                const users = snapshot.val();
                
                if (!users) {
                    throw new Error('No hay usuarios registrados en el sistema');
                }
                
                let userFound = false;
                let userData = null;
                
                for (const [userId, user] of Object.entries(users)) {
                    if (user.nombre === username && user.password === password) {
                        userFound = true;
                        userData = {
                            id: userId,
                            nombre: user.nombre,
                            password: user.password,
                            ejecutivoId: user.ejecutivoId,
                            fechaCreacion: user.fechaCreacion
                        };
                        break;
                    }
                }
                
                if (!userFound) {
                    throw new Error('Usuario o contrase帽a incorrectos');
                }
                
                currentUser = userData;
                
                await loadEjecutivoInfo(userData.ejecutivoId);
                
                if (document.getElementById('remember-me').checked) {
                    localStorage.setItem('skyline_user', username);
                    localStorage.setItem('skyline_password', password);
                } else {
                    localStorage.removeItem('skyline_user');
                    localStorage.removeItem('skyline_password');
                }
                
                showMainApp();
                
            } catch (error) {
                showLoginError(error.message);
            } finally {
                showLoginLoading(false);
            }
        }

        async function loadEjecutivoInfo(ejecutivoId) {
            if (!ejecutivoId) {
                currentEjecutivo = null;
                return;
            }
            
            try {
                console.log('Buscando ejecutivo con ID:', ejecutivoId);
                
                const snapshot = await database.ref('ejecutivos').once('value');
                const ejecutivos = snapshot.val();
                
                if (!ejecutivos) {
                    console.log('No se encontraron ejecutivos en la base de datos');
                    currentEjecutivo = null;
                    return;
                }
                
                let ejecutivoEncontrado = null;
                for (const [ejecutivoKey, ejecutivoData] of Object.entries(ejecutivos)) {
                    console.log('Comparando:', ejecutivoKey, 'con', ejecutivoId);
                    if (ejecutivoKey === ejecutivoId) {
                        ejecutivoEncontrado = {
                            id: ejecutivoKey,
                            ...ejecutivoData
                        };
                        break;
                    }
                }
                
                if (ejecutivoEncontrado) {
                    currentEjecutivo = ejecutivoEncontrado;
                    console.log('Ejecutivo encontrado:', currentEjecutivo);
                } else {
                    console.log('No se encontr贸 el ejecutivo con ID:', ejecutivoId);
                    currentEjecutivo = null;
                }
            } catch (error) {
                console.error('Error cargando informaci贸n del ejecutivo:', error);
                currentEjecutivo = null;
            }
        }

        function logoutUser() {
            currentUser = null;
            currentEjecutivo = null;
            localStorage.removeItem('skyline_user');
            localStorage.removeItem('skyline_password');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('login-section').style.display = 'flex';
            document.querySelector('.navbar').style.display = 'none';
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.floating-action-btn').style.display = 'none';
            
            document.getElementById('login-form').reset();
            document.getElementById('login-error').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('login-section').style.display = 'none';
            document.querySelector('.navbar').style.display = 'flex';
            document.querySelector('.main-content').style.display = 'block';
            
            document.getElementById('current-user').textContent = currentUser.nombre;
            
            updatePromotorInfo();
            
            loadAllData();
        }

        function updatePromotorInfo() {
            document.getElementById('current-promotor-name').textContent = currentUser.nombre;
            document.getElementById('current-ejecutivo-name').textContent = currentEjecutivo ? currentEjecutivo.nombre : 'No asignado';
            
            document.getElementById('modal-promotor-name').textContent = currentUser.nombre;
            document.getElementById('modal-ejecutivo-name').textContent = currentEjecutivo ? currentEjecutivo.nombre : 'No asignado';
        }

        function showLoginLoading(show) {
            const loginBtn = document.getElementById('login-btn');
            if (show) {
                loginBtn.innerHTML = '<span class="loading-spinner"></span> Verificando...';
                loginBtn.disabled = true;
            } else {
                loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Iniciar Sesi贸n';
                loginBtn.disabled = false;
            }
        }

        function showLoginError(message) {
            const errorElement = document.getElementById('login-error');
            const errorText = document.getElementById('login-error-text');
            
            errorText.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // ===== FUNCIONES EXISTENTES MODIFICADAS =====

        function loadAllData() {
            if (!currentUser) {
                console.error('No hay usuario autenticado');
                return;
            }
            
            return loadExecutives()
                .then(() => loadSolicitudes())
                .then(() => {
                    console.log('Datos cargados correctamente para usuario:', currentUser.nombre);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        // ===== FUNCIONES DE VALIDACIN =====

        function validarNombreCompleto(nombre) {
            if (!nombre || nombre.trim() === '') {
                return { valido: false, mensaje: 'El nombre es obligatorio' };
            }
            
            nombre = nombre.trim().replace(/\s+/g, ' ');
            
            const partes = nombre.split(' ');
            if (partes.length < 2) {
                return { valido: false, mensaje: 'Debe ingresar al menos un nombre y un apellido' };
            }
            
            for (let parte of partes) {
                if (parte.length < 2) {
                    return { valido: false, mensaje: 'Cada nombre y apellido debe tener al menos 2 caracteres' };
                }
            }
            
            return { valido: true, nombre: nombre };
        }

        function validarFormatoINE(ine) {
            if (!ine || typeof ine !== 'string') {
                return { valido: false, mensaje: 'El n煤mero de INE es requerido' };
            }
            
            const ineLimpio = ine.trim().toUpperCase().replace(/\s+/g, '');
            
            if (ineLimpio.length !== 13 && ineLimpio.length !== 18) {
                return { 
                    valido: false, 
                    mensaje: 'El n煤mero de INE debe tener 13 o 18 caracteres' 
                };
            }
            
            if (ineLimpio.length === 13) {
                const regexViejo = /^[A-Z]{6}[0-9]{8}[A-Z0-9]{3}$/;
                if (!regexViejo.test(ineLimpio)) {
                    return {
                        valido: false,
                        mensaje: 'Formato de INE antiguo inv谩lido'
                    };
                }
            } else if (ineLimpio.length === 18) {
                const regexNuevo = /^[A-Z]{6}[0-9]{8}[A-Z0-9]{3}[0-9A-Z]{1}$/;
                if (!regexNuevo.test(ineLimpio)) {
                    return {
                        valido: false,
                        mensaje: 'Formato de INE nuevo inv谩lido'
                    };
                }
            }
            
            return {
                valido: true,
                ine: ineLimpio,
                formato: ineLimpio.length === 13 ? 'antiguo' : 'nuevo'
            };
        }

        function validarSolicitud(solicitudData) {
            const errores = [];
            const camposConError = [];

            const validacionNombre = validarNombreCompleto(solicitudData.nombre);
            if (!validacionNombre.valido) {
                errores.push(validacionNombre.mensaje);
                camposConError.push('nombre');
            } else {
                solicitudData.nombre = validacionNombre.nombre;
            }

            const validacionINE = validarFormatoINE(solicitudData.ine);
            if (!validacionINE.valido) {
                errores.push(`INE: ${validacionINE.mensaje}`);
                camposConError.push('ine');
            } else {
                solicitudData.ine = validacionINE.ine;
            }

            const camposObligatorios = [
                { campo: 'telefono', nombre: 'tel茅fono' },
                { campo: 'direccion', nombre: 'direcci贸n' },
                { campo: 'ciudad', nombre: 'ciudad' },
                { campo: 'estado', nombre: 'estado' },
                { campo: 'folioPagar茅', nombre: 'folio de pagar茅' },
                { campo: 'monto', nombre: 'monto solicitado' }
            ];

            camposObligatorios.forEach(({ campo, nombre }) => {
                if (!solicitudData[campo] || solicitudData[campo].toString().trim() === '') {
                    errores.push(`El ${nombre} es obligatorio`);
                    camposConError.push(campo);
                }
            });

            if (solicitudData.aval) {
                const camposAval = [
                    { campo: 'nombre', nombre: 'nombre del aval' },
                    { campo: 'parentesco', nombre: 'parentesco del aval' },
                    { campo: 'direccion', nombre: 'direcci贸n del aval' },
                    { campo: 'telefono', nombre: 'tel茅fono del aval' }
                ];

                camposAval.forEach(({ campo, nombre }) => {
                    if (!solicitudData.aval[campo] || solicitudData.aval[campo].toString().trim() === '') {
                        errores.push(`El ${nombre} es obligatorio`);
                        camposConError.push(`aval-${campo}`);
                    }
                });

                if (solicitudData.aval.nombre && solicitudData.aval.nombre.trim() !== '') {
                    const validacionAval = validarNombreCompleto(solicitudData.aval.nombre);
                    if (!validacionAval.valido) {
                        errores.push('Aval: ' + validacionAval.mensaje);
                        camposConError.push('aval-nombre');
                    } else {
                        solicitudData.aval.nombre = validacionAval.nombre;
                    }
                }
            }

            return {
                valido: errores.length === 0,
                errores: errores,
                camposConError: camposConError
            };
        }

        function mostrarErroresFormulario(camposConError, prefijo = 'solicitud') {
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            document.querySelectorAll('.invalid-feedback').forEach(el => {
                el.style.display = 'none';
            });
            
            camposConError.forEach(campo => {
                const elemento = document.getElementById(prefijo + campo.charAt(0).toUpperCase() + campo.slice(1));
                const errorElement = document.getElementById(prefijo + campo.charAt(0).toUpperCase() + campo.slice(1) + '-error');
                
                if (elemento) {
                    elemento.classList.add('is-invalid');
                }
                if (errorElement) {
                    errorElement.style.display = 'block';
                }
            });
        }

        // ===== FUNCIONES PARA CLCULO DE PAGOS =====

        function calculateWeeklyPayment(amount, rate) {
            return amount * (rate / 100);
        }

        function calculateSolicitudPayment() {
            const amount = parseFloat(document.getElementById('solicitudAmount').value) || 0;
            const rate = parseFloat(document.getElementById('solicitudRate').value) || 0;
            
            if (amount > 0 && rate > 0) {
                const weeklyPayment = calculateWeeklyPayment(amount, rate);
                document.getElementById('solicitud-payment-calculation-result').innerHTML = 
                    `<strong>Pago semanal estimado: $${weeklyPayment.toFixed(2)}</strong><br>
                     <small>$${amount.toLocaleString()}  ${rate}% = $${weeklyPayment.toFixed(2)}</small>`;
            } else {
                document.getElementById('solicitud-payment-calculation-result').textContent = 
                    'Ingrese el monto y la tasa para ver el c谩lculo';
            }
        }

        // ===== VALIDACIN EN TIEMPO REAL PARA INE =====

        function setupINEValidation() {
            const ineInputs = [
                'solicitudINE', 'solicitudAvalINE'
            ];
            
            ineInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('blur', function() {
                        validarINEEnTiempoReal(this);
                    });
                    
                    input.addEventListener('input', function(e) {
                        formatearINEEnTiempoReal(this, e);
                    });
                }
            });
        }

        function validarINEEnTiempoReal(inputElement) {
            const valor = inputElement.value.trim();
            if (valor === '') return;
            
            const validacion = validarFormatoINE(valor);
            const errorElement = document.getElementById(inputElement.id + '-error');
            
            if (!validacion.valido) {
                inputElement.classList.add('is-invalid');
                inputElement.classList.remove('is-valid');
                if (errorElement) {
                    errorElement.textContent = validacion.mensaje;
                    errorElement.style.display = 'block';
                }
            } else {
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                
                aplicarFormatoINE(inputElement, validacion.ine);
            }
        }

        function formatearINEEnTiempoReal(inputElement, event) {
            let valor = inputElement.value.toUpperCase();
            valor = valor.replace(/[^A-Z0-9]/g, '');
            
            if (valor.length > 18) {
                valor = valor.substring(0, 18);
            }
            
            inputElement.value = valor;
        }

        function aplicarFormatoINE(inputElement, ine) {
            if (ine.length === 13) {
                inputElement.value = `${ine.substring(0, 6)} ${ine.substring(6, 14)} ${ine.substring(14)}`;
            } else if (ine.length === 18) {
                inputElement.value = `${ine.substring(0, 6)} ${ine.substring(6, 14)} ${ine.substring(14, 17)} ${ine.substring(17)}`;
            }
        }

        // ===== FUNCIONES PRINCIPALES =====

        function clearSolicitudForm() {
            document.getElementById('solicitudName').value = '';
            document.getElementById('solicitudPhone').value = '';
            document.getElementById('solicitudAddress').value = '';
            document.getElementById('solicitudCity').value = '';
            document.getElementById('solicitudState').value = '';
            document.getElementById('solicitudINE').value = '';
            document.getElementById('solicitudFolio').value = '';
            
            document.getElementById('solicitudAmount').value = '';
            document.getElementById('solicitudTerm').value = '8';
            document.getElementById('solicitudRate').value = '12.5';
            document.getElementById('solicitudPurpose').value = '';
            document.getElementById('solicitud-payment-calculation-result').textContent = 'Ingrese el monto y la tasa para ver el c谩lculo';
            
            document.getElementById('solicitudAvalName').value = '';
            document.getElementById('solicitudAvalRelationship').value = '';
            document.getElementById('solicitudAvalAddress').value = '';
            document.getElementById('solicitudAvalPhone').value = '';
            document.getElementById('solicitudAvalINE').value = '';
            
            document.getElementById('guaranteeType').value = '';
            document.getElementById('guarantee-preview').style.display = 'none';
            document.getElementById('guarantee-photo-data').value = '';
            document.getElementById('guaranteeDescription').value = '';
            document.getElementById('facade-preview').style.display = 'none';
            document.getElementById('facade-photo-data').value = '';
            document.getElementById('guarantee-file-input').value = '';
            document.getElementById('facade-file-input').value = '';
            
            document.getElementById('location-status').innerHTML = '';
            currentLocation = null;
            
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            document.querySelectorAll('.is-valid').forEach(el => {
                el.classList.remove('is-valid');
            });
            document.querySelectorAll('.invalid-feedback').forEach(el => {
                el.style.display = 'none';
            });
            
            document.getElementById('client-data-tab').click();
        }

        // ===== FUNCIONES PARA AUTORIZACIN =====

        async function approveSolicitud() {
            if (!currentSolicitudId) return;
            
            const comments = document.getElementById('authorization-comments').value;
            
            try {
                await database.ref('solicitudes/' + currentSolicitudId).update({
                    estado: 'aprobada',
                    comentarios: comments,
                    fechaAutorizacion: new Date().toISOString()
                });
                
                alert(' Solicitud aprobada correctamente');
                bootstrap.Modal.getInstance(document.getElementById('viewSolicitudModal')).hide();
                loadSolicitudes();
                
            } catch (error) {
                console.error('Error approving solicitud:', error);
                alert('Error al aprobar solicitud: ' + error.message);
            }
        }

        async function reviewSolicitud() {
            if (!currentSolicitudId) return;
            
            const comments = document.getElementById('authorization-comments').value;
            
            try {
                await database.ref('solicitudes/' + currentSolicitudId).update({
                    estado: 'revision',
                    comentarios: comments
                });
                
                alert(' Solicitud marcada como en revisi贸n');
                bootstrap.Modal.getInstance(document.getElementById('viewSolicitudModal')).hide();
                loadSolicitudes();
                
            } catch (error) {
                console.error('Error updating solicitud:', error);
                alert('Error al actualizar solicitud: ' + error.message);
            }
        }

        async function rejectSolicitud() {
            if (!currentSolicitudId) return;
            
            const comments = document.getElementById('authorization-comments').value;
            
            try {
                await database.ref('solicitudes/' + currentSolicitudId).update({
                    estado: 'rechazada',
                    comentarios: comments,
                    fechaAutorizacion: new Date().toISOString()
                });
                
                alert(' Solicitud rechazada correctamente');
                bootstrap.Modal.getInstance(document.getElementById('viewSolicitudModal')).hide();
                loadSolicitudes();
                
            } catch (error) {
                console.error('Error rejecting solicitud:', error);
                alert('Error al rechazar solicitud: ' + error.message);
            }
        }

        // ===== FUNCIONES DE CARGA DE DATOS =====

        function loadSolicitudes() {
            return new Promise((resolve, reject) => {
                showLoading('solicitudes-table', 'Cargando solicitudes...');
                
                database.ref('solicitudes').once('value')
                    .then(snapshot => {
                        solicitudes = [];
                        snapshot.forEach(childSnapshot => {
                            solicitudes.push({ id: childSnapshot.key, ...childSnapshot.val() });
                        });
                        updateSolicitudesTable();
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error loading solicitudes:', error);
                        showError('solicitudes-table', 'Error al cargar solicitudes: ' + error.message);
                        reject(error);
                    });
            });
        }

        function loadExecutives() {
            return new Promise((resolve, reject) => {
                database.ref('ejecutivos').once('value')
                    .then(executivesSnapshot => {
                        executives = [];
                        executivesSnapshot.forEach(childSnapshot => {
                            const executive = { 
                                id: childSnapshot.key, 
                                ...childSnapshot.val() 
                            };
                            executives.push(executive);
                        });
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error loading executives:', error);
                        reject(error);
                    });
            });
        }

        // ===== FUNCIONES DE INTERFAZ =====

        function updateSolicitudesTable(filteredSolicitudes = null) {
            const solicitudesTable = document.getElementById('solicitudes-table');
            const solicitudesToShow = filteredSolicitudes || solicitudes;
            const countElement = document.getElementById('solicitudes-count');
            
            countElement.textContent = solicitudesToShow.length;
            
            if (solicitudesToShow.length === 0) {
                solicitudesTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="data-empty py-4">
                                <i class="bi bi-inbox"></i>
                                <p>No hay solicitudes registradas</p>
                                <button class="btn btn-primary desktop-action-btn" data-bs-toggle="modal" data-bs-target="#addSolicitudModal">
                                    <i class="bi bi-plus-circle"></i> Crear primera solicitud
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            solicitudesTable.innerHTML = '';
            solicitudesToShow.forEach(solicitud => {
                const promotorName = solicitud.promotor ? solicitud.promotor.nombre : 'No asignado';
                const ejecutivoName = solicitud.ejecutivo ? solicitud.ejecutivo.nombre : 'No asignado';
                
                const fecha = new Date(solicitud.fechaSolicitud);
                const fechaFormateada = fecha.toLocaleDateString();
                
                let estadoClass = 'status-pending';
                if (solicitud.estado === 'aprobada') estadoClass = 'status-approved';
                if (solicitud.estado === 'rechazada') estadoClass = 'status-rejected';
                if (solicitud.estado === 'revision') estadoClass = 'status-review';
                
                const nombreCorto = solicitud.nombre.length > 20 ? 
                    solicitud.nombre.substring(0, 20) + '...' : solicitud.nombre;
                
                solicitudesTable.innerHTML += `
                    <tr>
                        <td>
                            <div class="fw-bold">${nombreCorto}</div>
                            <small class="text-muted d-md-none">${fechaFormateada}</small>
                        </td>
                        <td class="d-none d-md-table-cell">${solicitud.telefono || 'N/A'}</td>
                        <td>$${(solicitud.monto || 0).toLocaleString()}</td>
                        <td class="d-none d-lg-table-cell">${promotorName}</td>
                        <td class="d-none d-lg-table-cell">${ejecutivoName}</td>
                        <td>
                            <span class="badge ${estadoClass}">
                                ${solicitud.estado || 'pendiente'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewSolicitudDetails('${solicitud.id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function viewSolicitudDetails(solicitudId) {
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            if (!solicitud) return;
            
            currentSolicitudId = solicitudId;
            
            const weeklyPayment = calculateWeeklyPayment(solicitud.monto || 0, solicitud.tasaInteres || 0);
            
            const fecha = new Date(solicitud.fechaSolicitud);
            const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
            
            document.getElementById('view-solicitud-name').textContent = solicitud.nombre || 'Nombre no disponible';
            document.getElementById('view-solicitud-fecha').textContent = fechaFormateada;
            
            const statusElement = document.getElementById('view-solicitud-status');
            statusElement.textContent = solicitud.estado || 'pendiente';
            statusElement.className = 'badge';
            if (solicitud.estado === 'pendiente') statusElement.classList.add('status-pending');
            if (solicitud.estado === 'aprobada') statusElement.classList.add('status-approved');
            if (solicitud.estado === 'rechazada') statusElement.classList.add('status-rejected');
            if (solicitud.estado === 'revision') statusElement.classList.add('status-review');
            
            document.getElementById('view-solicitud-promotor').textContent = solicitud.promotor ? solicitud.promotor.nombre : 'No asignado';
            document.getElementById('view-solicitud-ejecutivo').textContent = solicitud.ejecutivo ? solicitud.ejecutivo.nombre : 'No asignado';
            
            document.getElementById('view-solicitud-phone').textContent = solicitud.telefono || 'N/A';
            document.getElementById('view-solicitud-address').textContent = solicitud.direccion || 'N/A';
            document.getElementById('view-solicitud-city').textContent = solicitud.ciudad || 'N/A';
            document.getElementById('view-solicitud-state').textContent = solicitud.estado || 'N/A';
            document.getElementById('view-solicitud-ine').textContent = solicitud.ine || 'N/A';
            document.getElementById('view-solicitud-folio').textContent = solicitud.folioPagar茅 || 'N/A';
            document.getElementById('view-solicitud-amount').textContent = `$${(solicitud.monto || 0).toLocaleString()}`;
            document.getElementById('view-solicitud-rate').textContent = `${solicitud.tasaInteres || 0}%`;
            document.getElementById('view-solicitud-term').textContent = `${solicitud.plazo || 0} semanas`;
            document.getElementById('view-solicitud-purpose').textContent = solicitud.proposito || 'No especificado';
            document.getElementById('view-solicitud-payment').textContent = `$${weeklyPayment.toLocaleString()}`;
            
            if (solicitud.aval) {
                document.getElementById('view-solicitud-aval-name').textContent = solicitud.aval.nombre || 'N/A';
                document.getElementById('view-solicitud-aval-relationship').textContent = solicitud.aval.parentesco || 'N/A';
                document.getElementById('view-solicitud-aval-phone').textContent = solicitud.aval.telefono || 'N/A';
                document.getElementById('view-solicitud-aval-address').textContent = solicitud.aval.direccion || 'N/A';
                
                if (solicitud.aval.ine) {
                    document.getElementById('view-solicitud-aval-ine').textContent = solicitud.aval.ine;
                    document.getElementById('aval-ine-container').style.display = 'block';
                } else {
                    document.getElementById('aval-ine-container').style.display = 'none';
                }
            } else {
                document.getElementById('view-solicitud-aval-name').textContent = 'No registrado';
                document.getElementById('view-solicitud-aval-relationship').textContent = 'N/A';
                document.getElementById('view-solicitud-aval-phone').textContent = 'N/A';
                document.getElementById('view-solicitud-aval-address').textContent = 'N/A';
                document.getElementById('aval-ine-container').style.display = 'none';
            }
            
            if (solicitud.garantia) {
                document.getElementById('view-solicitud-guarantee-type').textContent = solicitud.garantia.tipo || 'No especificado';
                document.getElementById('view-solicitud-guarantee-description').textContent = solicitud.garantia.descripcion || 'No especificado';
                
                if (solicitud.garantia.foto) {
                    document.getElementById('view-solicitud-guarantee-photo').src = solicitud.garantia.foto;
                    document.getElementById('guarantee-photo-container').style.display = 'block';
                } else {
                    document.getElementById('guarantee-photo-container').style.display = 'none';
                }
            } else {
                document.getElementById('view-solicitud-guarantee-type').textContent = 'No registrada';
                document.getElementById('view-solicitud-guarantee-description').textContent = 'N/A';
                document.getElementById('guarantee-photo-container').style.display = 'none';
            }
            
            if (solicitud.fachada && solicitud.fachada.foto) {
                document.getElementById('view-solicitud-facade-photo').src = solicitud.fachada.foto;
                document.getElementById('facade-photo-container').style.display = 'block';
            } else {
                document.getElementById('facade-photo-container').style.display = 'none';
            }
            
            const authorizationSection = document.getElementById('authorization-section');
            if (solicitud.estado === 'pendiente' || solicitud.estado === 'revision') {
                authorizationSection.style.display = 'block';
                document.getElementById('authorization-comments').value = solicitud.comentarios || '';
            } else {
                authorizationSection.style.display = 'none';
            }
            
            const viewModal = new bootstrap.Modal(document.getElementById('viewSolicitudModal'));
            viewModal.show();
        }

        // ===== FUNCIONES DE BSQUEDA Y FILTROS =====

        function searchSolicitudes(searchTerm) {
            const resultsContainer = document.getElementById('solicitud-search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                updateSolicitudesTable();
                return;
            }
            
            const filteredSolicitudes = solicitudes.filter(solicitud => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    (solicitud.nombre && solicitud.nombre.toLowerCase().includes(searchLower)) ||
                    (solicitud.telefono && solicitud.telefono.includes(searchTerm)) ||
                    (solicitud.ine && solicitud.ine.toLowerCase().includes(searchLower))
                );
            });
            
            if (filteredSolicitudes.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No se encontraron solicitudes</div>';
                resultsContainer.style.display = 'block';
                
                const solicitudesTable = document.getElementById('solicitudes-table');
                solicitudesTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="data-empty py-4">
                                <i class="bi bi-search"></i>
                                <p>No se encontraron solicitudes que coincidan con la b煤squeda</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            resultsContainer.innerHTML = '';
            filteredSolicitudes.forEach(solicitud => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div>
                        <strong>${solicitud.nombre}</strong>
                        <div class="small text-muted">
                            ${solicitud.telefono ? `Tel: ${solicitud.telefono}` : ''}
                            ${solicitud.ine ? ` | INE: ${solicitud.ine}` : ''}
                        </div>
                `;
                
                item.addEventListener('click', function() {
                    document.getElementById('solicitud-search').value = solicitud.nombre;
                    resultsContainer.style.display = 'none';
                    updateSolicitudesTable([solicitud]);
                });
                
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.style.display = 'block';
            updateSolicitudesTable(filteredSolicitudes);
        }

        function filterSolicitudesByStatus(status) {
            if (status === 'all') {
                updateSolicitudesTable();
                return;
            }
            
            const filteredSolicitudes = solicitudes.filter(solicitud => 
                solicitud.estado === status
            );
            
            updateSolicitudesTable(filteredSolicitudes);
        }

        // ===== CONFIGURACIN DE EVENT LISTENERS =====

        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                if (!username || !password) {
                    showLoginError('Por favor ingrese usuario y contrase帽a');
                    return;
                }
                
                loginUser(username, password);
            });
            
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            document.getElementById('save-solicitud-btn').addEventListener('click', function() {
                addSolicitud();
            });
            
            document.getElementById('refresh-solicitudes-btn').addEventListener('click', loadSolicitudes);
            document.getElementById('refresh-solicitudes-btn-mobile').addEventListener('click', loadSolicitudes);
            
            document.getElementById('solicitudAmount').addEventListener('input', calculateSolicitudPayment);
            document.getElementById('solicitudRate').addEventListener('input', calculateSolicitudPayment);
            
            document.getElementById('get-location-btn').addEventListener('click', function() {
                console.log(' Bot贸n de ubicaci贸n clickeado');
                
                // Verificar si Google Maps est谩 cargado
                if (!googleMapsLoaded || !geocoder) {
                    console.log(' Google Maps no est谩 listo, inicializando...');
                    updateLocationStatus('loading', 'Inicializando servicios de ubicaci贸n...');
                    initializeGoogleMapsWithRetry();
                    
                    // Esperar a que se inicialice y luego obtener ubicaci贸n
                    setTimeout(() => {
                        if (googleMapsLoaded && geocoder) {
                            getCurrentLocation();
                        } else {
                            updateLocationStatus('error', 'No se pudieron inicializar los servicios de ubicaci贸n');
                        }
                    }, 3000);
                    return;
                }
                
                this.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Obteniendo...';
                this.disabled = true;
                
                getCurrentLocation();
                
                // Restaurar el bot贸n despu茅s de 10 segundos m谩ximo
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-geo-alt"></i> Ubicaci贸n';
                    this.disabled = false;
                }, 10000);
            });
            
            document.getElementById('solicitud-search').addEventListener('input', function() {
                searchSolicitudes(this.value);
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('solicitud-search-results').style.display = 'none';
                }
            });
            
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-filter]').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    filterSolicitudesByStatus(filter);
                });
            });
            
            document.getElementById('approve-solicitud-btn').addEventListener('click', approveSolicitud);
            document.getElementById('review-solicitud-btn').addEventListener('click', reviewSolicitud);
            document.getElementById('reject-solicitud-btn').addEventListener('click', rejectSolicitud);
            
            document.getElementById('addSolicitudModal').addEventListener('hidden.bs.modal', function () {
                clearSolicitudForm();
            });
            
            document.getElementById('guaranteeType').addEventListener('change', function() {
                if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                }
            });
        }

        // ===== FUNCIONES UTILITARIAS =====

        function showLoading(elementId, message = 'Cargando...') {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> ${message}
                </div>
            `;
        }

        // ===== INICIALIZACIN MEJORADA DE LA APLICACIN =====

        function initApp() {
            setupEventListeners();
            setupScanner();
            setupINEValidation();
            checkExistingSession();
            
            // Detectar capacidades del dispositivo
            detectDeviceCapabilities();
            
            // Inicializar Google Maps de forma m谩s robusta
            initializeGoogleMapsWithRetry();
            
            // Configurar geolocalizaci贸n despu茅s de que cargue todo
            setTimeout(() => {
                setupGeolocationFallbacks();
            }, 2000);
        }

        // Detectar capacidades del dispositivo
        function detectDeviceCapabilities() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            const supportsOrientation = 'orientation' in screen;
            
            console.log('Capacidades del dispositivo:', {
                isMobile,
                hasCamera,
                supportsOrientation,
                userAgent: navigator.userAgent
            });
            
            // Aplicar clases espec铆ficas seg煤n capacidades
            if (isMobile) {
                document.body.classList.add('is-mobile');
            }
            
            if (!hasCamera) {
                document.body.classList.add('no-camera');
                // Ocultar botones de c谩mara si no est谩 disponible
                document.querySelectorAll('.camera-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            if (supportsOrientation) {
                document.body.classList.add('supports-orientation');
            }
        }
        // Agregar funciones al objeto global
        window.viewSolicitudDetails = viewSolicitudDetails;
        window.initGoogleMapsServices = initGoogleMapsServices;
    </script>
</body>
</html>